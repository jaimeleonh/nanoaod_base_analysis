<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cmt.base_tasks.plotting &mdash; nanoaod-base-analysis 0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> nanoaod-base-analysis
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">nanoaod-base-analysis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>cmt.base_tasks.plotting</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cmt.base_tasks.plotting</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plotting tasks.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span> <span class="k">as</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">law</span>
<span class="kn">import</span> <span class="nn">luigi</span>
<span class="kn">import</span> <span class="nn">plotlib.root</span> <span class="k">as</span> <span class="nn">r</span>
<span class="kn">from</span> <span class="nn">cmt.util</span> <span class="kn">import</span> <span class="n">hist_to_array</span><span class="p">,</span> <span class="n">hist_to_graph</span><span class="p">,</span> <span class="n">get_graph_maximum</span><span class="p">,</span> <span class="n">update_graph_values</span>

<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_double</span>


<span class="kn">from</span> <span class="nn">analysis_tools</span> <span class="kn">import</span> <span class="n">ObjectCollection</span>
<span class="kn">from</span> <span class="nn">analysis_tools.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">import_root</span><span class="p">,</span> <span class="n">create_file_dir</span><span class="p">,</span> <span class="n">join_root_selection</span><span class="p">,</span> <span class="n">randomize</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">plotting_tools.root</span> <span class="kn">import</span> <span class="n">get_labels</span><span class="p">,</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">RatioCanvas</span>
<span class="kn">from</span> <span class="nn">cmt.base_tasks.base</span> <span class="kn">import</span> <span class="p">(</span> 
    <span class="n">DatasetTaskWithCategory</span><span class="p">,</span> <span class="n">DatasetWrapperTask</span><span class="p">,</span> <span class="n">HTCondorWorkflow</span><span class="p">,</span> <span class="n">ConfigTaskWithCategory</span><span class="p">,</span>
    <span class="n">RDFModuleTask</span><span class="p">,</span> <span class="n">InputData</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">cmt.base_tasks.preprocessing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Preprocess</span><span class="p">,</span> <span class="n">MergeCategorization</span><span class="p">,</span> <span class="n">MergeCategorizationStats</span><span class="p">,</span> <span class="n">EventCounterDAS</span>
<span class="p">)</span>

<span class="n">cmt_style</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_style&quot;</span><span class="p">)</span>
<span class="n">cmt_style</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">ErrorX</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cmt_style</span><span class="o">.</span><span class="n">x_axis</span><span class="o">.</span><span class="n">TitleOffset</span> <span class="o">=</span> <span class="mf">1.22</span>
<span class="n">cmt_style</span><span class="o">.</span><span class="n">y_axis</span><span class="o">.</span><span class="n">TitleOffset</span> <span class="o">=</span> <span class="mf">1.48</span>
<span class="n">cmt_style</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">TextSize</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">cmt_style</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">legend_dy</span> <span class="o">=</span> <span class="mf">0.035</span>
<span class="n">cmt_style</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">legend_y2</span> <span class="o">=</span> <span class="mf">0.93</span>

<span class="n">EMPTY</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.e5</span>

<span class="n">ROOT</span> <span class="o">=</span> <span class="n">import_root</span><span class="p">()</span>

<div class="viewcode-block" id="BasePlotTask"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.BasePlotTask">[docs]</a><span class="k">class</span> <span class="nc">BasePlotTask</span><span class="p">(</span><span class="n">ConfigTaskWithCategory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that wraps parameters used in all plotting tasks. Can&#39;t be run.</span>

<span class="sd">    :param feature_names: names of features to plot. Uses all features when empty.</span>
<span class="sd">    :type feature_names: csv string</span>

<span class="sd">    :param feature_tags: list of tags for filtering features selected via feature names.</span>
<span class="sd">    :type feature_tags: csv string</span>

<span class="sd">    :param skip_feature_names: names or name pattern of features to skip</span>
<span class="sd">    :type skip_feature_names: csv string</span>

<span class="sd">    :param skip_feature_tags: list of tags of features to skip</span>
<span class="sd">    :type skip_feature_tags: csv string</span>

<span class="sd">    :param apply_weights: whether to apply weights and scaling to all histograms.</span>
<span class="sd">    :type apply_weights: bool</span>

<span class="sd">    :param n_bins: NOT YET IMPLEMENTED. Custom number of bins for plotting,</span>
<span class="sd">        defaults to the value configured by the feature when empty.</span>
<span class="sd">    :type n_bins: int</span>

<span class="sd">    :param systematics: NOT YET IMPLEMENTED. List of custom systematics to be considered.</span>
<span class="sd">    :type systematics: csv list</span>

<span class="sd">    :param shape_region: shape region used for QCD computation.</span>
<span class="sd">    :type shape_region: str from choice list</span>

<span class="sd">    :param remove_horns: NOT YET IMPLEMENTED. Whether to remove the eta horns present in 2017</span>
<span class="sd">    :type remove_horns: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;names of features to plot, uses all &quot;</span>
        <span class="s2">&quot;features when empty, default: ()&quot;</span><span class="p">)</span>
    <span class="n">feature_tags</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;list of tags for filtering features &quot;</span>
        <span class="s2">&quot;selected via feature_names, default: ()&quot;</span><span class="p">)</span>
    <span class="n">skip_feature_names</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;names or name pattern of &quot;</span>
        <span class="s2">&quot;features to skip, default: ()&quot;</span><span class="p">)</span>
    <span class="n">skip_feature_tags</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;multiclass_dnn&quot;</span><span class="p">,),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;list of tags of &quot;</span>
        <span class="s2">&quot;features to skip, default: (multiclass_dnn,)&quot;</span><span class="p">)</span>
    <span class="n">apply_weights</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to apply &quot;</span>
        <span class="s2">&quot;mc weights to histograms, default: True&quot;</span><span class="p">)</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">IntParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">law</span><span class="o">.</span><span class="n">NO_INT</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;custom number of bins for &quot;</span>
        <span class="s2">&quot;plotting, defaults to the value configured by the feature when empty, default: empty&quot;</span><span class="p">)</span>
    <span class="n">systematics</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;list of systematics, default: empty&quot;</span><span class="p">)</span>
    <span class="n">shape_region</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">ChoiceParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;os_inviso&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;os_inviso&quot;</span><span class="p">,</span> <span class="s2">&quot;ss_iso&quot;</span><span class="p">),</span>
        <span class="n">significant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;shape region default: os_inviso&quot;</span><span class="p">)</span>
    <span class="n">remove_horns</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to remove horns &quot;</span>
        <span class="s2">&quot;from distributions, default: False&quot;</span><span class="p">)</span>

    <span class="n">tree_name</span> <span class="o">=</span> <span class="s2">&quot;Events&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BasePlotTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># select features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_features</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">law</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">multi_match</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feature</span><span class="o">.</span><span class="n">has_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_tags</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_feature_names</span> <span class="ow">and</span> \
                    <span class="n">law</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">multi_match</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_feature_names</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_feature_tags</span> <span class="ow">and</span> <span class="n">feature</span><span class="o">.</span><span class="n">has_tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_feature_tags</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span> <span class="nf">get_binning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="n">y_axis_adendum</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; / </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">binning</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature</span><span class="o">.</span><span class="n">binning</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">feature</span><span class="o">.</span><span class="n">binning</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">binning</span><span class="p">,</span> <span class="n">y_axis_adendum</span>

    <span class="k">def</span> <span class="nf">get_feature_systematics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">systematics</span>

    <span class="k">def</span> <span class="nf">get_systs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">isMC</span><span class="p">):</span>
        <span class="n">systs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isMC</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">systs</span>
        <span class="k">for</span> <span class="n">syst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_systematics</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
            <span class="n">systs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">systs</span>

    <span class="k">def</span> <span class="nf">get_output_postfix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">postfix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_weights</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__noweights&quot;</span>
        <span class="k">return</span> <span class="n">postfix</span></div>


<div class="viewcode-block" id="PrePlot"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot">[docs]</a><span class="k">class</span> <span class="nc">PrePlot</span><span class="p">(</span><span class="n">DatasetTaskWithCategory</span><span class="p">,</span> <span class="n">BasePlotTask</span><span class="p">,</span> <span class="n">law</span><span class="o">.</span><span class="n">LocalWorkflow</span><span class="p">,</span> <span class="n">HTCondorWorkflow</span><span class="p">,</span>
        <span class="n">RDFModuleTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the filling of histograms for all features considered. If systematics are considered,</span>
<span class="sd">    it also produces the same histograms after applying those.</span>

<span class="sd">    :param skip_processing: whether to skip the preprocessing and categorization steps.</span>
<span class="sd">    :type skip_processing: bool</span>
<span class="sd">    :param skip_merging: whether to skip the MergeCategorization task.</span>
<span class="sd">    :type skip_processing: bool</span>
<span class="sd">    :param preplot_modules_file: filename inside ``cmt/config/`` or ``../config/`` (w/o extension)</span>
<span class="sd">        with the RDF modules to run.</span>
<span class="sd">    :type preplot_modules_file: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">skip_processing</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to skip&quot;</span>
        <span class="s2">&quot; preprocessing and categorization steps, default: False&quot;</span><span class="p">)</span>
    <span class="n">skip_merging</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to skip&quot;</span>
        <span class="s2">&quot; MergeCategorization task, default: False&quot;</span><span class="p">)</span>
    <span class="n">preplot_modules_file</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;filename with modules to run RDataFrame&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PrePlot.create_branch_map"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot.create_branch_map">[docs]</a>    <span class="k">def</span> <span class="nf">create_branch_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: number of files after merging (usually 1) unless skip_processing == True</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_processing</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_merging</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s2">&quot;$CMT_TMP_DIR/</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">add_prefix</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_files_after_merging</span></div>

<div class="viewcode-block" id="PrePlot.workflow_requires"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot.workflow_requires">[docs]</a>    <span class="k">def</span> <span class="nf">workflow_requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_merging</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">Categorization</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">)}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_processing</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">InputData</span><span class="o">.</span><span class="n">req</span><span class="p">(</span><span class="bp">self</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">MergeCategorization</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">)}</span></div>

<div class="viewcode-block" id="PrePlot.requires"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Each branch requires one input file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_merging</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">Categorization</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">file_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">)}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_processing</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">InputData</span><span class="o">.</span><span class="n">req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MergeCategorization</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">)</span></div>

<div class="viewcode-block" id="PrePlot.output"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: One file per input file with all histograms to be plotted for each feature</span>
<span class="sd">        :rtype: `.root`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;data</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">.root&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">))</span></div>

<div class="viewcode-block" id="PrePlot.get_weight"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot.get_weight">[docs]</a>    <span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">syst_direction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains the product of all weights depending on the category/channel applied.</span>
<span class="sd">        Returns &quot;1&quot; if it&#39;s a data sample or the apply_weights parameter is set to False.</span>

<span class="sd">        :return: Product of all weights to be applied</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">isData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_weights</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_weights_expression</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">category</span><span class="p">],</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">syst_direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">default</span></div>

<div class="viewcode-block" id="PrePlot.run"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.PrePlot.run">[docs]</a>    <span class="nd">@law</span><span class="o">.</span><span class="n">decorator</span><span class="o">.</span><span class="n">notify</span>
    <span class="nd">@law</span><span class="o">.</span><span class="n">decorator</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates one RDataFrame per input file, runs the desired RDFModules</span>
<span class="sd">        and produces a set of plots per each feature, one for the nominal value</span>
<span class="sd">        and others (if available) for all systematics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isMC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">isMC</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">]</span>

        <span class="c1"># prepare inputs and outputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_processing</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span><span class="o">.</span><span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
        <span class="n">outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="o">.</span><span class="n">path</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_name</span><span class="p">,</span> <span class="n">inp</span><span class="p">)</span>

        <span class="n">modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_modules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preplot_modules_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">selection</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="n">dataset_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;selection&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_processing</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_object_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">isMC</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dataset_selection</span> <span class="ow">and</span> <span class="n">dataset_selection</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">join_root_selection</span><span class="p">(</span><span class="n">dataset_selection</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">dataset_selection</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="o">!=</span> <span class="n">law</span><span class="o">.</span><span class="n">NO_STR</span><span class="p">:</span>
            <span class="n">region_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">)</span><span class="o">.</span><span class="n">selection</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">join_root_selection</span><span class="p">(</span><span class="n">region_selection</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;and&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">region_selection</span>

        <span class="k">if</span> <span class="n">selection</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;selection&quot;</span><span class="p">)</span>

        <span class="n">tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_name</span><span class="p">)</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">()</span>
        <span class="n">histos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">binning_args</span><span class="p">,</span> <span class="n">y_axis_adendum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_binning</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">x_title</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;x_title&quot;</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">y_title</span> <span class="o">=</span> <span class="s2">&quot;Events&quot;</span> <span class="o">+</span> <span class="n">y_axis_adendum</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;; </span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_title</span><span class="p">,</span> <span class="n">y_title</span><span class="p">)</span>
            <span class="n">systs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systs</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">isMC</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_weights_systematics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">isMC</span><span class="p">)</span>
            <span class="n">systs_directions</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">isMC</span><span class="p">:</span>
                <span class="n">systs_directions</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">systs</span><span class="p">,</span> <span class="n">directions</span><span class="p">))</span>

            <span class="c1"># apply selection if needed</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">selection</span><span class="p">:</span>
                <span class="n">feat_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s2">&quot;feat_selection&quot;</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span><span class="o">.</span><span class="n">Filter</span><span class="p">(</span><span class="s2">&quot;feat_selection&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feat_df</span> <span class="o">=</span> <span class="n">df</span>

            <span class="c1"># loop over systematics and up/down variations</span>
            <span class="k">for</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">systs_directions</span><span class="p">:</span>
                <span class="c1"># define tag just for histograms&#39;s name</span>
                <span class="k">if</span> <span class="n">syst_name</span> <span class="o">!=</span> <span class="s2">&quot;central&quot;</span> <span class="ow">and</span> <span class="n">isMC</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">syst_name</span>
                    <span class="k">if</span> <span class="n">direction</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">tag</span> <span class="o">+=</span> <span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">direction</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">feature_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_object_expression</span><span class="p">(</span>
                    <span class="n">feature</span><span class="p">,</span> <span class="n">isMC</span><span class="p">,</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
                <span class="n">feature_name</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">tag</span>
                <span class="n">hist_base</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="o">*</span><span class="n">binning_args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hmodel</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RDF</span><span class="o">.</span><span class="n">TH1DModel</span><span class="p">(</span><span class="n">hist_base</span><span class="p">)</span>
                    <span class="n">histos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">feat_df</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
                            <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_weight</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
                            <span class="s2">&quot;var&quot;</span><span class="p">,</span> <span class="n">feature_expression</span><span class="p">)</span><span class="o">.</span><span class="n">Histo1D</span><span class="p">(</span><span class="n">hmodel</span><span class="p">,</span> <span class="s2">&quot;var&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># no entries available, append empty histogram</span>
                    <span class="n">histos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist_base</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="n">outp</span><span class="p">),</span> <span class="s2">&quot;RECREATE&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histos</span><span class="p">:</span>
            <span class="n">histo</span> <span class="o">=</span> <span class="n">histo</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
            <span class="n">histo</span><span class="o">.</span><span class="n">Sumw2</span><span class="p">()</span>
            <span class="n">histo</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="FeaturePlot"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot">[docs]</a><span class="k">class</span> <span class="nc">FeaturePlot</span><span class="p">(</span><span class="n">BasePlotTask</span><span class="p">,</span> <span class="n">DatasetWrapperTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the actual histogram plotting: loads the histograms obtained in the PrePlot tasks,</span>
<span class="sd">    rescales them if needed and plots and saves them.</span>

<span class="sd">    Example command:</span>

<span class="sd">    ``law run FeaturePlot --version test --category-name etau --config-name ul_2018 \</span>
<span class="sd">--process-group-name etau --feature-names Htt_svfit_mass,lep1_pt,bjet1_pt,lep1_eta,bjet1_eta \</span>
<span class="sd">--workers 20 --PrePlot-workflow local --stack --hide-data False --do-qcd --region-name etau_os_iso\</span>
<span class="sd">--dataset-names tt_dl,tt_sl,dy_high,wjets,data_etau_a,data_etau_b,data_etau_c,data_etau_d \</span>
<span class="sd">--MergeCategorizationStats-version test_old --PrePlot-workflow htcondor``</span>

<span class="sd">    :param stack: whether to show all backgrounds stacked (True) or normalized to 1 (False)</span>
<span class="sd">    :type stack: bool</span>

<span class="sd">    :param do_qcd: whether to estimate QCD using the ABCD method</span>
<span class="sd">    :type do_qcd: bool</span>

<span class="sd">    :param qcd_wp: working point to use for QCD estimation</span>
<span class="sd">    :type qcd_wp: str from choice list</span>

<span class="sd">    :param qcd_signal_region_wp: region to use as signal region for QCD estimation</span>
<span class="sd">    :type qcd_signal_region_wp: str</span>

<span class="sd">    :param shape_region: region to use as shape region for QCD estimation</span>
<span class="sd">    :type shape_region: str from choice list</span>

<span class="sd">    :param qcd_sym_shape: whether to symmetrise the shape coming from both possible shape regions</span>
<span class="sd">    :type qcd_sym_shape: bool</span>

<span class="sd">    :param qcd_category_name: category name used for the same sign regions in QCD estimation</span>
<span class="sd">    :type qcd_category_name: str</span>

<span class="sd">    :param hide_data: whether to show (False) or hide (True) the data histograms</span>
<span class="sd">    :type hide_data: bool</span>

<span class="sd">    :param normalize_signals: (NOT YET IMPLEMENTED) whether to normalize signals to the</span>
<span class="sd">        total background yield (True) or not (False)</span>
<span class="sd">    :type normalize_signals: bool</span>

<span class="sd">    :param blinded: (NOT YET IMPLEMENTED) whether to blind data in specified regions</span>
<span class="sd">    :type blinded: bool</span>

<span class="sd">    :param save_png: whether to save plots in png</span>
<span class="sd">    :type save_png: bool</span>

<span class="sd">    :param save_pdf: whether to save plots in pdf</span>
<span class="sd">    :type save_pdf: bool</span>

<span class="sd">    :param save_root: whether to write plots in a root file</span>
<span class="sd">    :type save_root: bool</span>

<span class="sd">    :param save_yields: (NOT YET IMPLEMENTED) whether to save histogram yields in a json file</span>
<span class="sd">    :type save_yields: bool</span>

<span class="sd">    :param process_group_name: name of the process grouping name</span>
<span class="sd">    :type process_group_name: str</span>

<span class="sd">    :param bins_in_x_axis: (NOT YET IMPLEMENTED) whether to plot histograms with the bin numbers</span>
<span class="sd">        in the x axis instead of the actual values</span>
<span class="sd">    :type bins_in_x_axis: bool</span>

<span class="sd">    :param plot_systematics: (NOT YET FULLY IMPLEMENTED) whether to plot histograms</span>
<span class="sd">        with their uncertainties</span>
<span class="sd">    :type plot_systematics: bool</span>

<span class="sd">    :param fixed_colors: whether to plot histograms with their defined colors (False) or fixed colors</span>
<span class="sd">        (True) starting from ``ROOT`` color ``2``.</span>
<span class="sd">    :type fixed_colors: bool</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;when set, stack backgrounds, weight &quot;</span>
        <span class="s2">&quot;them with dataset and category weights, and normalize afterwards, default: False&quot;</span><span class="p">)</span>
    <span class="n">do_qcd</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to compute the QCD shape, &quot;</span>
        <span class="s2">&quot;default: False&quot;</span><span class="p">)</span>
    <span class="n">qcd_wp</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">ChoiceParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">law</span><span class="o">.</span><span class="n">NO_STR</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="n">law</span><span class="o">.</span><span class="n">NO_STR</span><span class="p">,</span> <span class="s2">&quot;vvvl_vvl&quot;</span><span class="p">,</span> <span class="s2">&quot;vvl_vl&quot;</span><span class="p">,</span> <span class="s2">&quot;vl_l&quot;</span><span class="p">,</span> <span class="s2">&quot;l_m&quot;</span><span class="p">),</span> <span class="n">significant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;working points to use for qcd computation, default: empty (vvvl - m)&quot;</span><span class="p">)</span>
    <span class="n">qcd_signal_region_wp</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;os_iso&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;signal region wp, &quot;</span>
        <span class="s2">&quot;default: os_iso&quot;</span><span class="p">)</span>
    <span class="n">shape_region</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">ChoiceParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;os_inviso&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;os_inviso&quot;</span><span class="p">,</span> <span class="s2">&quot;ss_iso&quot;</span><span class="p">),</span>
        <span class="n">significant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;shape region default: os_inviso&quot;</span><span class="p">)</span>
    <span class="n">qcd_sym_shape</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;symmetrize QCD shape, &quot;</span>
        <span class="s2">&quot;default: False&quot;</span><span class="p">)</span>
    <span class="n">qcd_category_name</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;category use &quot;</span>
        <span class="s2">&quot;for qcd regions ss_iso and ss_inviso, default=default (same as category)&quot;</span><span class="p">)</span>
    <span class="n">hide_data</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;hide data events, default: True&quot;</span><span class="p">)</span>
    <span class="n">normalize_signals</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to normalize &quot;</span>
        <span class="s2">&quot;signals to the total bkg yield, default: True&quot;</span><span class="p">)</span>
    <span class="n">blinded</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to blind bins above a &quot;</span>
        <span class="s2">&quot;certain feature value, default: False&quot;</span><span class="p">)</span>
    <span class="n">save_png</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to save created histograms &quot;</span>
        <span class="s2">&quot;in png, default: True&quot;</span><span class="p">)</span>
    <span class="n">save_pdf</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to save created histograms &quot;</span>
        <span class="s2">&quot;in pdf, default: True&quot;</span><span class="p">)</span>
    <span class="n">save_root</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to save created histograms &quot;</span>
        <span class="s2">&quot;in root files, default: False&quot;</span><span class="p">)</span>
    <span class="n">save_yields</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to save event yields per &quot;</span>
        <span class="s2">&quot;process, default: False&quot;</span><span class="p">)</span>
    <span class="n">process_group_name</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;the name of the process &quot;</span>
        <span class="s2">&quot;grouping, only encoded into output paths when changed, default: default&quot;</span><span class="p">)</span>
    <span class="n">bins_in_x_axis</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to show in the x axis &quot;</span>
        <span class="s2">&quot;bin numbers instead of the feature value, default: False&quot;</span><span class="p">)</span>
    <span class="n">plot_systematics</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether plot systematics, &quot;</span>
        <span class="s2">&quot;default: True&quot;</span><span class="p">)</span>
    <span class="n">fixed_colors</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to use fixed colors &quot;</span>
        <span class="s2">&quot;for plotting, default: False&quot;</span><span class="p">)</span>
    <span class="n">log_y</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;set logarithmic scale for Y axis, &quot;</span>
        <span class="s2">&quot;default: False&quot;</span><span class="p">)</span>
    <span class="c1"># # optimization parameters</span>
    <span class="c1"># bin_opt_version = luigi.Parameter(default=law.NO_STR, description=&quot;version of the binning &quot;</span>
        <span class="c1"># &quot;optimization task to use, not used when empty, default: empty&quot;)</span>
    <span class="c1"># n_start_bins = luigi.IntParameter(default=10, description=&quot;number of bins to be used &quot;</span>
        <span class="c1"># &quot;as initial value for scans, default: 10&quot;)</span>
    <span class="c1"># optimization_method = luigi.ChoiceParameter(default=&quot;flat_s&quot;,</span>
        <span class="c1"># choices=(&quot;flat_s&quot;, &quot;flat_b&quot;, &quot;flat_sb&quot;, &quot;flat_s_b&quot;, &quot;const&quot;, &quot;flat_mpp&quot;, &quot;flat_mpp_sb&quot;),</span>
        <span class="c1"># significant=False, description=&quot;optimization method to be used, default: flat signal&quot;)</span>
    <span class="c1"># threshold = luigi.FloatParameter(default=-1., description=&quot;threshold per bin, &quot;</span>
        <span class="c1"># &quot;default: -1.&quot;)</span>
    <span class="c1"># threshold_method = luigi.ChoiceParameter(default=&quot;yield&quot;,</span>
        <span class="c1"># choices=(&quot;yield&quot;, &quot;raw_events&quot;, &quot;tt_dy&quot;, &quot;tt_and_dy&quot;, &quot;tt_dy_and_yield&quot;,</span>
            <span class="c1"># &quot;tt_and_dy_and_yield&quot;, &quot;rel_error&quot;),</span>
        <span class="c1"># significant=False, description=&quot;threshold method to be used, default: yield&quot;)</span>
    <span class="c1"># region_to_optimize = luigi.Parameter(default=law.NO_STR, description=&quot;region used for the &quot;</span>
        <span class="c1"># &quot;optimization, default: same region as plot&quot;)</span>

    <span class="c1"># Not implemented yet</span>
    <span class="n">bin_opt_version</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># remove_horns = False</span>

    <span class="n">default_process_group_name</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FeaturePlot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># select processes and datasets</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">process_group_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets_to_run</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">get_processes</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">ObjectCollection</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="p">:</span>
                <span class="n">process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">parent_process</span><span class="p">:</span>
                <span class="n">processes</span> <span class="o">+=</span> <span class="n">get_processes</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">parent_process</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">processes</span>

        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="n">get_processes</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
            <span class="n">filtered_processes</span> <span class="o">=</span> <span class="n">ObjectCollection</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">process_group_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span><span class="p">]:</span>
                    <span class="n">filtered_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
            <span class="c1"># print dataset.name, [process.name for process in processes]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_processes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> process group name includes not orthogonal processes </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_processes</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_processes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">filtered_processes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">process</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="p">[</span><span class="n">process</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets_to_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># get QCD regions when requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcd_regions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_qcd</span><span class="p">:</span>
            <span class="n">wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_wp</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_wp</span> <span class="o">!=</span> <span class="n">law</span><span class="o">.</span><span class="n">NO_STR</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qcd_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_qcd_regions</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
                <span class="n">wp</span><span class="o">=</span><span class="n">wp</span><span class="p">,</span> <span class="n">shape_region</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_region</span><span class="p">,</span> <span class="n">signal_region_wp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_signal_region_wp</span><span class="p">,</span>
                <span class="n">sym</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_sym_shape</span><span class="p">)</span>

            <span class="c1"># complain when no data is present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">isData</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no real dataset passed for QCD estimation&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FeaturePlot.requires"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All requirements needed:</span>

<span class="sd">            * Histograms coming from the PrePlot task.</span>

<span class="sd">            * Number of total events coming from the MergeCategorizationStats task \</span>
<span class="sd">              (to normalize MC histograms).</span>

<span class="sd">            * If estimating QCD, FeaturePlot for the three additional QCD regions needed.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">reqs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">PrePlot</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_category</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets_to_run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets_to_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">isData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_weights</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;secondary_dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">MergeCategorizationStats</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;secondary_dataset&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">MergeCategorizationStats</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">dataset_name</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_qcd</span><span class="p">:</span>
            <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;qcd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">blinded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">do_qcd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_pdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_yields</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">remove_horns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">_exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;feature_tags&quot;</span><span class="p">,</span> <span class="s2">&quot;shape_region&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;qcd_category_name&quot;</span><span class="p">,</span> <span class="s2">&quot;qcd_sym_shape&quot;</span><span class="p">,</span> <span class="s2">&quot;qcd_signal_region_wp&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_regions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_category_name</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;qcd&quot;</span><span class="p">][</span><span class="s2">&quot;ss_iso&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FeaturePlot</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_regions</span><span class="o">.</span><span class="n">ss_iso</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_category_name</span><span class="p">,</span>
                    <span class="n">blinded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_qcd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">save_pdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_yields</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_feature</span><span class="p">,),</span>
                    <span class="n">bin_opt_version</span><span class="o">=</span><span class="n">law</span><span class="o">.</span><span class="n">NO_STR</span><span class="p">,</span> <span class="n">remove_horns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_horns</span><span class="p">,</span> <span class="n">_exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;feature_tags&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;shape_region&quot;</span><span class="p">,</span> <span class="s2">&quot;qcd_category_name&quot;</span><span class="p">,</span> <span class="s2">&quot;qcd_sym_shape&quot;</span><span class="p">,</span> <span class="s2">&quot;bin_opt_version&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;qcd_signal_region_wp&quot;</span><span class="p">])</span>
                <span class="c1"># reqs[&quot;qcd&quot;][&quot;os_inviso&quot;] = FeaturePlot.vreq(self,</span>
                    <span class="c1"># region_name=self.qcd_regions.os_inviso.name, category_name=self.qcd_category_name,</span>
                    <span class="c1"># blinded=False, hide_data=False, do_qcd=False, stack=True, save_root=True,</span>
                    <span class="c1"># save_pdf=True, save_yields=True, feature_names=(self.qcd_feature,),</span>
                    <span class="c1"># remove_horns=self.remove_horns, _exclude=[&quot;feature_tags&quot;, &quot;bin_opt_version&quot;])</span>
                <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;qcd&quot;</span><span class="p">][</span><span class="s2">&quot;ss_inviso&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FeaturePlot</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_regions</span><span class="o">.</span><span class="n">ss_inviso</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">category_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_category_name</span><span class="p">,</span>
                    <span class="n">blinded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_qcd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">save_pdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_yields</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qcd_feature</span><span class="p">,),</span>
                    <span class="n">bin_opt_version</span><span class="o">=</span><span class="n">law</span><span class="o">.</span><span class="n">NO_STR</span><span class="p">,</span> <span class="n">remove_horns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_horns</span><span class="p">,</span> <span class="n">_exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;feature_tags&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;shape_region&quot;</span><span class="p">,</span> <span class="s2">&quot;qcd_category_name&quot;</span><span class="p">,</span> <span class="s2">&quot;qcd_sym_shape&quot;</span><span class="p">,</span> <span class="s2">&quot;bin_opt_version&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;qcd_signal_region_wp&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">reqs</span></div>

<div class="viewcode-block" id="FeaturePlot.get_output_postfix"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.get_output_postfix">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_postfix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :return: string to be included in the output filenames</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">postfix</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FeaturePlot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_process_group_name</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__pg_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_qcd</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__qcd&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_data</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__nodata&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">blinded</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;yields&quot;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__blinded&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;yields&quot;</span><span class="p">):</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;__stack&quot;</span>
        <span class="k">return</span> <span class="n">postfix</span></div>

<div class="viewcode-block" id="FeaturePlot.output"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output files to be filled: pdf, png, root or json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># output definitions, i.e. key, file prefix, extension</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_pdf</span><span class="p">:</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_png</span><span class="p">:</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_root</span><span class="p">:</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;root/&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_yields</span><span class="p">:</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;yields&quot;</span><span class="p">,</span> <span class="s2">&quot;yields/&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">law</span><span class="o">.</span><span class="n">SiblingFileCollection</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">prefix</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">ext</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
            <span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">output_data</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="FeaturePlot.complete"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.complete">[docs]</a>    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Task is completed when all output are present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ConfigTaskWithCategory</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeaturePlot.setup_signal_hist"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.setup_signal_hist">[docs]</a>    <span class="k">def</span> <span class="nf">setup_signal_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to apply signal format to an histogram</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">hist_type</span> <span class="o">=</span> <span class="s2">&quot;signal&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">legend_style</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeaturePlot.setup_background_hist"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.setup_background_hist">[docs]</a>    <span class="k">def</span> <span class="nf">setup_background_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to apply background format to an histogram</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">hist_type</span> <span class="o">=</span> <span class="s2">&quot;background&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">ROOT</span><span class="o">.</span><span class="n">kBlack</span><span class="p">)</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">SetLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">SetFillColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">legend_style</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">legend_style</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span></div>

<div class="viewcode-block" id="FeaturePlot.setup_data_hist"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.setup_data_hist">[docs]</a>    <span class="k">def</span> <span class="nf">setup_data_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to apply data format to an histogram</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">legend_style</span> <span class="o">=</span> <span class="s2">&quot;lp&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">hist_type</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">SetMarkerStyle</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">SetMarkerColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">SetLineColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">SetBinErrorOption</span><span class="p">((</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1</span><span class="o">.</span><span class="n">kPoisson</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1</span><span class="o">.</span><span class="n">kNormal</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeaturePlot.get_systematics"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.get_systematics">[docs]</a>    <span class="k">def</span> <span class="nf">get_systematics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to extract all normalization systematics from the KLUB files.</span>
<span class="sd">        It considers the processes given by the process_group_name and their parents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># systematics</span>
        <span class="n">systematics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
            <span class="n">all_signal_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_background_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isSignal</span><span class="p">:</span>
                    <span class="n">all_signal_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;llr_name&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;llr_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isData</span><span class="p">:</span>
                    <span class="n">all_background_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;llr_name&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;llr_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">cmt.analysis.systReader</span> <span class="kn">import</span> <span class="n">systReader</span>
            <span class="n">syst_folder</span> <span class="o">=</span> <span class="s2">&quot;files/systematics/&quot;</span>
            <span class="n">syst</span> <span class="o">=</span> <span class="n">systReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieve_file</span><span class="p">(</span><span class="n">syst_folder</span> <span class="o">+</span> <span class="s2">&quot;systematics_</span><span class="si">{}</span><span class="s2">.cfg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">year</span><span class="p">)),</span> <span class="n">all_signal_names</span><span class="p">,</span> <span class="n">all_background_names</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">syst</span><span class="o">.</span><span class="n">writeOutput</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">syst</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_channel_from_region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;mutau&quot;</span><span class="p">):</span>
                <span class="n">syst</span><span class="o">.</span><span class="n">addSystFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieve_file</span><span class="p">(</span><span class="n">syst_folder</span>
                    <span class="o">+</span> <span class="s2">&quot;systematics_mutau_</span><span class="si">%s</span><span class="s2">.cfg&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="s2">&quot;etau&quot;</span><span class="p">):</span>
                <span class="n">syst</span><span class="o">.</span><span class="n">addSystFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieve_file</span><span class="p">(</span><span class="n">syst_folder</span>
                    <span class="o">+</span> <span class="s2">&quot;systematics_etau_</span><span class="si">%s</span><span class="s2">.cfg&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">syst</span><span class="o">.</span><span class="n">addSystFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieve_file</span><span class="p">(</span><span class="n">syst_folder</span> <span class="o">+</span> <span class="s2">&quot;syst_th.cfg&quot;</span><span class="p">))</span>
            <span class="n">syst</span><span class="o">.</span><span class="n">writeSystematics</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">isy</span><span class="p">,</span> <span class="n">syst_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">syst</span><span class="o">.</span><span class="n">SystNames</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;CMS_scale_t&quot;</span> <span class="ow">in</span> <span class="n">syst</span><span class="o">.</span><span class="n">SystNames</span><span class="p">[</span><span class="n">isy</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;CMS_scale_j&quot;</span> <span class="ow">in</span> <span class="n">syst</span><span class="o">.</span><span class="n">SystNames</span><span class="p">[</span><span class="n">isy</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                    <span class="n">process</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">process</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">process_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;llr_name&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;llr_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="n">syst</span><span class="o">.</span><span class="n">SystProcesses</span><span class="p">[</span><span class="n">isy</span><span class="p">]:</span>
                            <span class="n">iproc</span> <span class="o">=</span> <span class="n">syst</span><span class="o">.</span><span class="n">SystProcesses</span><span class="p">[</span><span class="n">isy</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span>
                            <span class="n">systVal</span> <span class="o">=</span> <span class="n">syst</span><span class="o">.</span><span class="n">SystValues</span><span class="p">[</span><span class="n">isy</span><span class="p">][</span><span class="n">iproc</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">systematics</span><span class="p">:</span>
                                <span class="n">systematics</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">systematics</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">syst_name</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">systVal</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">parent_process</span><span class="p">:</span>
                            <span class="n">process</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">parent_process</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">for</span> <span class="n">dataset_name</span> <span class="ow">in</span> <span class="n">systematics</span><span class="p">:</span>
                <span class="n">systematics</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">systematics</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">]]))</span>
        <span class="k">return</span> <span class="n">systematics</span></div>

<div class="viewcode-block" id="FeaturePlot.plot"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the actual plotting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># helper to extract the qcd shape in a region</span>
        <span class="k">def</span> <span class="nf">get_qcd</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">bin_limit</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
            <span class="n">d_hist</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;histograms/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">d_hist</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;data histogram &#39;</span><span class="si">{}</span><span class="s2">&#39; not found for region &#39;</span><span class="si">{}</span><span class="s2">&#39; in tfile </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">region</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="n">region</span><span class="p">]))</span>

            <span class="n">b_hists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_names</span><span class="p">:</span>
                <span class="n">b_hist</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;histograms/&quot;</span> <span class="o">+</span> <span class="n">b_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">b_hist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;background histogram &#39;</span><span class="si">{}</span><span class="s2">&#39; not found in region &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">b_name</span><span class="p">,</span> <span class="n">region</span><span class="p">))</span>
                <span class="n">b_hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_hist</span><span class="p">)</span>

            <span class="n">qcd_hist</span> <span class="o">=</span> <span class="n">d_hist</span><span class="o">.</span><span class="n">Clone</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;qcd_&quot;</span> <span class="o">+</span> <span class="n">region</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">b_hists</span><span class="p">:</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>

            <span class="c1"># removing negative bins</span>
            <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ibin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">bin_limit</span><span class="p">:</span>
                    <span class="n">qcd_hist</span><span class="o">.</span><span class="n">SetBinContent</span><span class="p">(</span><span class="n">ibin</span><span class="p">,</span> <span class="mf">1.e-6</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">qcd_hist</span>

        <span class="k">def</span> <span class="nf">get_integral_and_error</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">integral</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">IntegralAndError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hist</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">value</span>
            <span class="n">compatible</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">integral</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="c1"># compatible = True if integral - error &lt;= 0 else False</span>
            <span class="k">return</span> <span class="n">integral</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">compatible</span>

        <span class="n">background_hists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]</span>
        <span class="n">signal_hists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">]</span>
        <span class="n">data_hists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">all_hists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
            <span class="n">bkg_histo_syst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;bkg_histo_syst&quot;</span><span class="p">]</span>

        <span class="n">binning_args</span><span class="p">,</span> <span class="n">y_axis_adendum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_binning</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">x_title</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;x_title&quot;</span><span class="p">))</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">y_title</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Events&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="s2">&quot;Normalized Events&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_axis_adendum</span>
        <span class="n">hist_title</span> <span class="o">=</span> <span class="s2">&quot;; </span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_title</span><span class="p">,</span> <span class="n">y_title</span><span class="p">)</span>

        <span class="c1"># qcd shape files</span>
        <span class="n">qcd_shape_files</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_qcd</span><span class="p">:</span>
            <span class="n">qcd_shape_files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_regions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_category_name</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                    <span class="n">my_feature</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="s2">&quot;shape&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;os_inviso&quot;</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcd_feature</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">my_feature</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span>
                <span class="n">qcd_shape_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;qcd&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">my_feature</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># do the qcd extrapolation</span>
            <span class="k">if</span> <span class="s2">&quot;shape&quot;</span> <span class="ow">in</span> <span class="n">qcd_shape_files</span><span class="p">:</span>
                <span class="n">qcd_hist</span> <span class="o">=</span> <span class="n">get_qcd</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="n">qcd_shape_files</span><span class="p">)</span><span class="o">.</span><span class="n">Clone</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;qcd&quot;</span><span class="p">))</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Integral</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#sym shape</span>
                <span class="n">qcd_hist</span> <span class="o">=</span> <span class="n">get_qcd</span><span class="p">(</span><span class="s2">&quot;shape1&quot;</span><span class="p">,</span> <span class="n">qcd_shape_files</span><span class="p">)</span><span class="o">.</span><span class="n">Clone</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;qcd&quot;</span><span class="p">))</span>
                <span class="n">qcd_hist2</span> <span class="o">=</span> <span class="n">get_qcd</span><span class="p">(</span><span class="s2">&quot;shape2&quot;</span><span class="p">,</span> <span class="n">qcd_shape_files</span><span class="p">)</span><span class="o">.</span><span class="n">Clone</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;qcd&quot;</span><span class="p">))</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Integral</span><span class="p">())</span>
                <span class="n">qcd_hist2</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">qcd_hist2</span><span class="o">.</span><span class="n">Integral</span><span class="p">())</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">qcd_hist2</span><span class="p">)</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="n">n_os_inviso</span><span class="p">,</span> <span class="n">n_os_inviso_error</span><span class="p">,</span> <span class="n">n_os_inviso_compatible</span> <span class="o">=</span> <span class="n">get_integral_and_error</span><span class="p">(</span>
                <span class="n">get_qcd</span><span class="p">(</span><span class="s2">&quot;os_inviso&quot;</span><span class="p">,</span> <span class="n">qcd_shape_files</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">))</span>
            <span class="n">n_ss_iso</span><span class="p">,</span> <span class="n">n_ss_iso_error</span><span class="p">,</span> <span class="n">n_ss_iso_compatible</span> <span class="o">=</span> <span class="n">get_integral_and_error</span><span class="p">(</span>
                <span class="n">get_qcd</span><span class="p">(</span><span class="s2">&quot;ss_iso&quot;</span><span class="p">,</span> <span class="n">qcd_shape_files</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">))</span>
            <span class="n">n_ss_inviso</span><span class="p">,</span> <span class="n">n_ss_inviso_error</span><span class="p">,</span> <span class="n">n_ss_inviso_compatible</span> <span class="o">=</span> <span class="n">get_integral_and_error</span><span class="p">(</span>
                <span class="n">get_qcd</span><span class="p">(</span><span class="s2">&quot;ss_inviso&quot;</span><span class="p">,</span> <span class="n">qcd_shape_files</span><span class="p">,</span> <span class="o">-</span><span class="mi">999</span><span class="p">))</span>
            <span class="c1"># if not n_ss_iso or not n_ss_inviso:</span>
            <span class="k">if</span> <span class="n">n_os_inviso_compatible</span> <span class="ow">or</span> <span class="n">n_ss_iso_compatible</span> <span class="ow">or</span> <span class="n">n_ss_inviso_compatible</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;****WARNING: QCD normalization failed (negative yield), Removing QCD!&quot;</span><span class="p">)</span>
                <span class="n">qcd_scaling</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">qcd_inviso</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">qcd_inviso_error</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">qcd_scaling</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qcd_inviso</span> <span class="o">=</span> <span class="n">n_os_inviso</span> <span class="o">/</span> <span class="n">n_ss_inviso</span>
                <span class="n">qcd_inviso_error</span> <span class="o">=</span> <span class="n">qcd_inviso</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">n_os_inviso_error</span> <span class="o">/</span> <span class="n">n_os_inviso</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_os_inviso_error</span> <span class="o">/</span> <span class="n">n_os_inviso</span><span class="p">)</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">n_ss_inviso_error</span> <span class="o">/</span> <span class="n">n_ss_inviso</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_ss_inviso_error</span> <span class="o">/</span> <span class="n">n_ss_inviso</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">qcd_scaling</span> <span class="o">=</span> <span class="n">n_os_inviso</span> <span class="o">*</span> <span class="n">n_ss_iso</span> <span class="o">/</span> <span class="n">n_ss_inviso</span>
                <span class="n">os_inviso_rel_error</span> <span class="o">=</span> <span class="n">n_os_inviso_error</span> <span class="o">/</span> <span class="n">n_os_inviso</span>
                <span class="n">ss_iso_rel_error</span> <span class="o">=</span> <span class="n">n_ss_iso_error</span> <span class="o">/</span> <span class="n">n_ss_iso</span>
                <span class="n">ss_inviso_rel_error</span> <span class="o">=</span> <span class="n">n_ss_inviso_error</span> <span class="o">/</span> <span class="n">n_ss_inviso</span>
                <span class="n">new_errors_sq</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">bin_rel_error</span> <span class="o">=</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetBinError</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="o">/</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bin_rel_error</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">new_errors_sq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bin_rel_error</span> <span class="o">*</span> <span class="n">bin_rel_error</span>
                        <span class="o">+</span> <span class="n">os_inviso_rel_error</span> <span class="o">*</span> <span class="n">os_inviso_rel_error</span>
                        <span class="o">+</span> <span class="n">ss_iso_rel_error</span> <span class="o">*</span> <span class="n">ss_iso_rel_error</span>
                        <span class="o">+</span> <span class="n">ss_inviso_rel_error</span> <span class="o">*</span> <span class="n">ss_inviso_rel_error</span><span class="p">)</span>
                <span class="n">qcd_hist</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">qcd_scaling</span><span class="p">)</span>
                <span class="c1"># fix errors</span>
                <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">qcd_hist</span><span class="o">.</span><span class="n">SetBinError</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span>
                        <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">new_errors_sq</span><span class="p">[</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>

            <span class="c1"># store and style</span>
            <span class="n">yield_error</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">qcd_hist</span><span class="o">.</span><span class="n">cmt_yield</span> <span class="o">=</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">IntegralAndError</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">qcd_hist</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">yield_error</span><span class="p">)</span>
            <span class="n">qcd_hist</span><span class="o">.</span><span class="n">cmt_yield_error</span> <span class="o">=</span> <span class="n">yield_error</span><span class="o">.</span><span class="n">value</span>
            <span class="n">qcd_hist</span><span class="o">.</span><span class="n">cmt_scale</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="n">qcd_hist</span><span class="o">.</span><span class="n">cmt_process_name</span> <span class="o">=</span> <span class="s2">&quot;qcd&quot;</span>
            <span class="n">qcd_hist</span><span class="o">.</span><span class="n">process_label</span> <span class="o">=</span> <span class="s2">&quot;QCD&quot;</span>
            <span class="n">qcd_hist</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s2">&quot;QCD&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_background_hist</span><span class="p">(</span><span class="n">qcd_hist</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kYellow</span><span class="p">)</span>
            <span class="n">background_hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qcd_hist</span><span class="p">)</span>
            <span class="n">all_hists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qcd_hist</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_data</span><span class="p">:</span>
            <span class="n">all_hists</span> <span class="o">+=</span> <span class="n">data_hists</span>

        <span class="n">bkg_histo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data_histo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">all_hists</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">Integral</span><span class="p">()</span> <span class="ow">or</span> <span class="mf">1.</span><span class="p">)</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
            <span class="n">draw_hists</span> <span class="o">=</span> <span class="n">all_hists</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">background_stack</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">THStack</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;stack&quot;</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">background_hists</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># hist.SetFillColor(ROOT.kRed)</span>
                <span class="n">background_stack</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">bkg_histo</span><span class="p">:</span>
                    <span class="n">bkg_histo</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bkg_histo</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">Clone</span><span class="p">())</span>
            <span class="n">background_stack</span><span class="o">.</span><span class="n">hist_type</span> <span class="o">=</span> <span class="s2">&quot;background&quot;</span>
            <span class="n">draw_hists</span> <span class="o">=</span> <span class="p">[</span><span class="n">background_stack</span><span class="p">]</span> <span class="o">+</span> <span class="n">signal_hists</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_data</span><span class="p">:</span>
                <span class="n">draw_hists</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data_hists</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">data_hists</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_histo</span><span class="p">:</span>
                        <span class="n">data_histo</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data_histo</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">Clone</span><span class="p">())</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="p">[(</span><span class="n">hist</span><span class="p">,</span> <span class="n">hist</span><span class="o">.</span><span class="n">process_label</span><span class="p">,</span> <span class="n">hist</span><span class="o">.</span><span class="n">legend_style</span><span class="p">)</span> <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">all_hists</span><span class="p">]</span>
        <span class="n">n_entries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_entries</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">n_entries</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">col_width</span> <span class="o">=</span> <span class="mf">0.125</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_entries</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_cols</span><span class="p">))</span>
        <span class="n">row_width</span> <span class="o">=</span> <span class="mf">0.06</span>
        <span class="n">legend_x2</span> <span class="o">=</span> <span class="mf">0.88</span>
        <span class="n">legend_x1</span> <span class="o">=</span> <span class="n">legend_x2</span> <span class="o">-</span> <span class="n">n_cols</span> <span class="o">*</span> <span class="n">col_width</span>
        <span class="n">legend_y2</span> <span class="o">=</span> <span class="mf">0.88</span>
        <span class="n">legend_y1</span> <span class="o">=</span> <span class="n">legend_y2</span> <span class="o">-</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">row_width</span>

        <span class="n">legend</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLegend</span><span class="p">(</span><span class="n">legend_x1</span><span class="p">,</span> <span class="n">legend_y1</span><span class="p">,</span> <span class="n">legend_x2</span><span class="p">,</span> <span class="n">legend_y2</span><span class="p">)</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">SetBorderSize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">SetNColumns</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">legend</span><span class="o">.</span><span class="n">AddEntry</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span>

        <span class="n">dummy_hist</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1F</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;dummy&quot;</span><span class="p">),</span> <span class="n">hist_title</span><span class="p">,</span> <span class="o">*</span><span class="n">binning_args</span><span class="p">)</span>
        <span class="c1"># Draw</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_hists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_y</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">SetLogy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">RatioCanvas</span><span class="p">()</span>
            <span class="n">dummy_hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetLabelOffset</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">dummy_hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitleOffset</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">get_pad</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_y</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">get_pad</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">SetLogy</span><span class="p">()</span>

        <span class="c1"># r.setup_hist(dummy_hist, pad=c.get_pad(1))</span>
        <span class="n">r</span><span class="o">.</span><span class="n">setup_hist</span><span class="p">(</span><span class="n">dummy_hist</span><span class="p">)</span>
        <span class="n">dummy_hist</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetMaxDigits</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">hist</span><span class="o">.</span><span class="n">GetMaximum</span><span class="p">()</span> <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">draw_hists</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_y</span><span class="p">:</span>
            <span class="n">dummy_hist</span><span class="o">.</span><span class="n">SetMaximum</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">maximum</span><span class="p">)</span>
            <span class="n">dummy_hist</span><span class="o">.</span><span class="n">SetMinimum</span><span class="p">(</span><span class="mf">0.0011</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dummy_hist</span><span class="o">.</span><span class="n">SetMaximum</span><span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">maximum</span><span class="p">)</span>
            <span class="n">dummy_hist</span><span class="o">.</span><span class="n">SetMinimum</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

        <span class="n">draw_labels</span> <span class="o">=</span> <span class="n">get_labels</span><span class="p">(</span><span class="n">upper_right</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">dummy_hist</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ih</span><span class="p">,</span> <span class="n">hist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">draw_hists</span><span class="p">):</span>
            <span class="n">option</span> <span class="o">=</span> <span class="s2">&quot;HIST,SAME&quot;</span> <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">hist_type</span> <span class="o">!=</span> <span class="s2">&quot;data&quot;</span> <span class="k">else</span> <span class="s2">&quot;PEZ,SAME&quot;</span>
            <span class="n">hist</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">draw_labels</span><span class="p">:</span>
            <span class="n">label</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="n">legend</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_data</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_hists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">background_hists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">dummy_ratio_hist</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1F</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;dummy&quot;</span><span class="p">),</span> <span class="n">hist_title</span><span class="p">,</span> <span class="o">*</span><span class="n">binning_args</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setup_hist</span><span class="p">(</span><span class="n">dummy_ratio_hist</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get_pad</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Minimum&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;Maximum&quot;</span><span class="p">:</span> <span class="mf">1.75</span><span class="p">})</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setup_y_axis</span><span class="p">(</span><span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">(),</span> <span class="n">pad</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">get_pad</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Ndivisions&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
            <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s2">&quot;Data / MC&quot;</span><span class="p">)</span>
            <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetXaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitleOffset</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetYaxis</span><span class="p">()</span><span class="o">.</span><span class="n">SetTitleOffset</span><span class="p">(</span><span class="mf">1.22</span><span class="p">)</span>

            <span class="n">data_graph</span> <span class="o">=</span> <span class="n">hist_to_graph</span><span class="p">(</span><span class="n">data_histo</span><span class="p">,</span> <span class="n">remove_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">asymm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">underflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cmt_process_name&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_hist_type&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_legend_style&quot;</span><span class="p">])</span>
            <span class="n">bkg_graph</span> <span class="o">=</span> <span class="n">hist_to_graph</span><span class="p">(</span><span class="n">bkg_histo</span><span class="p">,</span> <span class="n">remove_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">asymm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">underflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cmt_process_name&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_hist_type&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_legend_style&quot;</span><span class="p">])</span>

            <span class="n">ratio_graph</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TGraphAsymmErrors</span><span class="p">(</span><span class="n">binning_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mc_unc_graph</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TGraphErrors</span><span class="p">(</span><span class="n">binning_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setup_graph</span><span class="p">(</span><span class="n">ratio_graph</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;MarkerStyle&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;MarkerSize&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
            <span class="n">r</span><span class="o">.</span><span class="n">setup_graph</span><span class="p">(</span><span class="n">mc_unc_graph</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FillStyle&quot;</span><span class="p">:</span> <span class="mi">3004</span><span class="p">,</span> <span class="s2">&quot;LineColor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;MarkerColor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;MarkerSize&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">&quot;FillColor&quot;</span><span class="p">:</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kGray</span> <span class="o">+</span> <span class="mi">2</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
                <span class="n">syst_graph</span> <span class="o">=</span> <span class="n">hist_to_graph</span><span class="p">(</span><span class="n">bkg_histo_syst</span><span class="p">,</span> <span class="n">remove_zeros</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">asymm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">underflow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cmt_process_name&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_hist_type&quot;</span><span class="p">,</span> <span class="s2">&quot;cmt_legend_style&quot;</span><span class="p">])</span>
                <span class="n">syst_unc_graph</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TGraphErrors</span><span class="p">(</span><span class="n">binning_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">r</span><span class="o">.</span><span class="n">setup_graph</span><span class="p">(</span><span class="n">syst_unc_graph</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FillStyle&quot;</span><span class="p">:</span> <span class="mi">3005</span><span class="p">,</span> <span class="s2">&quot;LineColor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;MarkerColor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;MarkerSize&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">&quot;FillColor&quot;</span><span class="p">:</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kRed</span> <span class="o">+</span> <span class="mi">2</span><span class="p">})</span>
                <span class="n">all_unc_graph</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TGraphErrors</span><span class="p">(</span><span class="n">binning_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">r</span><span class="o">.</span><span class="n">setup_graph</span><span class="p">(</span><span class="n">all_unc_graph</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FillStyle&quot;</span><span class="p">:</span> <span class="mi">3007</span><span class="p">,</span> <span class="s2">&quot;LineColor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;MarkerColor&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;MarkerSize&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">&quot;FillColor&quot;</span><span class="p">:</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">kBlue</span> <span class="o">+</span> <span class="mi">2</span><span class="p">})</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binning_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                <span class="n">data_graph</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                <span class="n">bkg_graph</span><span class="o">.</span><span class="n">GetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">value</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">EMPTY</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ratio_graph</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ratio_graph</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">ratio_graph</span><span class="o">.</span><span class="n">SetPointEYhigh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data_graph</span><span class="o">.</span><span class="n">GetErrorYhigh</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">ratio_graph</span><span class="o">.</span><span class="n">SetPointEYlow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data_graph</span><span class="o">.</span><span class="n">GetErrorYlow</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span><span class="p">)</span>
                <span class="c1"># set the mc uncertainty</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mc_unc_graph</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mc_unc_graph</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                    <span class="n">mc_error</span> <span class="o">=</span> <span class="n">bkg_graph</span><span class="o">.</span><span class="n">GetErrorYhigh</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span>
                    <span class="n">mc_unc_graph</span><span class="o">.</span><span class="n">SetPointError</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetBinWidth</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                        <span class="n">mc_error</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
                    <span class="c1"># syst only</span>
                        <span class="n">syst_unc_graph</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                        <span class="n">syst_error</span> <span class="o">=</span> <span class="n">syst_graph</span><span class="o">.</span><span class="n">GetErrorYhigh</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span>
                        <span class="n">syst_unc_graph</span><span class="o">.</span><span class="n">SetPointError</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetBinWidth</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                            <span class="n">syst_error</span><span class="p">)</span>
                        <span class="c1"># syst + stat</span>
                        <span class="n">all_unc_graph</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                        <span class="n">tot_unc</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mc_error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">syst_error</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">all_unc_graph</span><span class="o">.</span><span class="n">SetPointError</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">GetBinWidth</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                            <span class="n">tot_unc</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">get_pad</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
            <span class="n">dummy_ratio_hist</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>
            <span class="n">mc_unc_graph</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;2,SAME&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_data</span><span class="p">:</span>
                <span class="n">ratio_graph</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;PEZ,SAME&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
                <span class="c1"># syst_unc_graph.Draw(&quot;2,SAME&quot;)</span>
                <span class="n">all_unc_graph</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;2,SAME&quot;</span><span class="p">)</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TLine</span><span class="p">(</span><span class="n">binning_args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">binning_args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">setup_line</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;NDC&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;LineStyle&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;LineWidth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;LineColor&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_png</span><span class="p">:</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="s2">&quot;png&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_pdf</span><span class="p">:</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="s2">&quot;pdf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_root</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;RECREATE&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
            <span class="c1"># c.Write(&quot;canvas&quot;) #FIXME</span>

            <span class="n">hist_dir</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;histograms&quot;</span><span class="p">)</span>
            <span class="n">hist_dir</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">all_hists</span><span class="p">:</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">cmt_process_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">syst_dir</span><span class="p">,</span> <span class="n">shape_hists</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">shape_hists</span><span class="p">:</span>
                        <span class="n">hist</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">cmt_process_name</span><span class="p">,</span> <span class="n">syst_dir</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span></div>

<div class="viewcode-block" id="FeaturePlot.run"><a class="viewcode-back" href="../../../api/base_tasks/plotting.html#cmt.base_tasks.plotting.FeaturePlot.run">[docs]</a>    <span class="nd">@law</span><span class="o">.</span><span class="n">decorator</span><span class="o">.</span><span class="n">notify</span>
    <span class="nd">@law</span><span class="o">.</span><span class="n">decorator</span><span class="o">.</span><span class="n">safe_output</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits processes into data, signal and background. Creates histograms from each process</span>
<span class="sd">        loading them from the input files. Scales the histograms and applies the correct format</span>
<span class="sd">        to them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ROOT</span><span class="o">.</span><span class="n">gStyle</span><span class="o">.</span><span class="n">SetOptStat</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># create root tchains for inputs</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="n">lumi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lumi_pb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isData</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isSignal</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isData</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isSignal</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
            <span class="n">systematics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systematics</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_colors</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="n">nevents</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iproc</span><span class="p">,</span> <span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">datasets</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">isData</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_weights</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
                    <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">][</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="c1"># nevents += stats[&quot;nevents&quot;]</span>
                        <span class="n">nevents</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;nweightedevents&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">histos</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;background&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="n">binning_args</span><span class="p">,</span> <span class="n">y_axis_adendum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_binning</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">x_title</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;x_title&quot;</span><span class="p">))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">y_title</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Events&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="k">else</span> <span class="s2">&quot;Normalized Events&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_axis_adendum</span>
            <span class="n">hist_title</span> <span class="o">=</span> <span class="s2">&quot;; </span><span class="si">%s</span><span class="s2">; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x_title</span><span class="p">,</span> <span class="n">y_title</span><span class="p">)</span>

            <span class="n">systs_directions</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;bkg_histo_syst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span><span class="p">(</span>
                    <span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;syst&quot;</span><span class="p">),</span> <span class="n">hist_title</span><span class="p">,</span> <span class="o">*</span><span class="n">binning_args</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">shape_systematics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systs</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> \
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_weights_systematics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

                <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">]</span>
                <span class="n">systs_directions</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">shape_systematics</span><span class="p">,</span> <span class="n">directions</span><span class="p">))</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="n">systs_directions</span><span class="p">:</span>
                <span class="n">feature_name</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">syst</span> <span class="o">==</span> <span class="s2">&quot;central&quot;</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">syst</span> <span class="o">!=</span> <span class="s2">&quot;central&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">][</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">iproc</span><span class="p">,</span> <span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">datasets</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">syst</span> <span class="o">!=</span> <span class="s2">&quot;central&quot;</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">isData</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">process_histo</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">hist_title</span><span class="p">,</span> <span class="o">*</span><span class="n">binning_args</span><span class="p">)</span>
                    <span class="n">process_histo</span><span class="o">.</span><span class="n">process_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">process_histo</span><span class="o">.</span><span class="n">cmt_process_name</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">process_histo</span><span class="o">.</span><span class="n">Sumw2</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
                        <span class="n">dataset_histo</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;tmp&quot;</span><span class="p">),</span> <span class="n">hist_title</span><span class="p">,</span> <span class="o">*</span><span class="n">binning_args</span><span class="p">)</span>
                        <span class="n">dataset_histo</span><span class="o">.</span><span class="n">Sumw2</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_category</span><span class="p">():</span>
                            <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">inp</span><span class="p">:</span>
                                <span class="n">rootfile</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                                <span class="n">histo</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">rootfile</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">feature_name</span><span class="p">))</span>
                                <span class="n">rootfile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
                                <span class="n">dataset_histo</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">histo</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">isData</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_weights</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">nevents</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">dataset_histo</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">xs</span> <span class="o">*</span> <span class="n">lumi</span> <span class="o">/</span> <span class="n">nevents</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                                    <span class="n">scaling</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_aux</span><span class="p">(</span><span class="s2">&quot;scaling&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scaling </span><span class="si">{}</span><span class="s2"> histo by </span><span class="si">{}</span><span class="s2"> +- </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                        <span class="n">old_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetBinError</span><span class="p">(</span><span class="n">ibin</span><span class="p">)</span>\
                                            <span class="o">/</span> <span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ibin</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ibin</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                            <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                                        <span class="n">new_errors</span> <span class="o">=</span> <span class="p">[</span>
                                            <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">elem</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">old_errors</span><span class="p">]</span>
                                        <span class="n">dataset_histo</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                            <span class="n">dataset_histo</span><span class="o">.</span><span class="n">SetBinError</span><span class="p">(</span>
                                                <span class="n">ibin</span><span class="p">,</span> <span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ibin</span><span class="p">)</span>
                                                    <span class="o">*</span> <span class="n">new_errors</span><span class="p">[</span><span class="n">ibin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

                        <span class="n">process_histo</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dataset_histo</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">isData</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">isSignal</span> \
                                <span class="ow">and</span> <span class="n">syst</span> <span class="o">==</span> <span class="s2">&quot;central&quot;</span><span class="p">:</span>
                            <span class="n">dataset_histo_syst</span> <span class="o">=</span> <span class="n">dataset_histo</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dataset_histo_syst</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="n">dataset_histo_syst</span><span class="o">.</span><span class="n">SetBinError</span><span class="p">(</span><span class="n">ibin</span><span class="p">,</span>
                                    <span class="nb">float</span><span class="p">(</span><span class="n">dataset_histo</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">ibin</span><span class="p">))</span>\
                                        <span class="o">*</span> <span class="n">systematics</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;bkg_histo_syst&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dataset_histo_syst</span><span class="p">)</span>

                    <span class="n">yield_error</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                    <span class="n">process_histo</span><span class="o">.</span><span class="n">cmt_yield</span> <span class="o">=</span> <span class="n">process_histo</span><span class="o">.</span><span class="n">IntegralAndError</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">process_histo</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">yield_error</span><span class="p">)</span>
                    <span class="n">process_histo</span><span class="o">.</span><span class="n">cmt_yield_error</span> <span class="o">=</span> <span class="n">yield_error</span><span class="o">.</span><span class="n">value</span>

                    <span class="k">if</span> <span class="n">syst</span> <span class="o">==</span> <span class="s2">&quot;central&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_colors</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">iproc</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TColor</span><span class="o">.</span><span class="n">GetColor</span><span class="p">(</span><span class="o">*</span><span class="n">process</span><span class="o">.</span><span class="n">color</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">color</span>

                        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">isSignal</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setup_signal_hist</span><span class="p">(</span><span class="n">process_histo</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_histo</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">isData</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setup_data_hist</span><span class="p">(</span><span class="n">process_histo</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_histo</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">setup_background_hist</span><span class="p">(</span><span class="n">process_histo</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_histo</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">isData</span><span class="p">:</span> <span class="c1">#or not self.hide_data:</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_histo</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">histos</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">][</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_histo</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>