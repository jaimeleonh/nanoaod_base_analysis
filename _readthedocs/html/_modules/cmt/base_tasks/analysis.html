<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cmt.base_tasks.analysis &mdash; nanoaod-base-analysis user guide 0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> nanoaod-base-analysis user guide
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Structure.html">Structure of the framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Configuration.html">Setting the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Environment.html">Setting the environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tasks.html">Executing tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">nanoaod-base-analysis user guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>cmt.base_tasks.analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cmt.base_tasks.analysis</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Analysis tasks.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">move</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span> <span class="k">as</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">tabulate</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_double</span>
<span class="kn">import</span> <span class="nn">uproot</span>

<span class="kn">import</span> <span class="nn">law</span>
<span class="kn">import</span> <span class="nn">luigi</span>

<span class="kn">from</span> <span class="nn">analysis_tools.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">import_root</span><span class="p">,</span> <span class="n">create_file_dir</span><span class="p">,</span> <span class="n">randomize</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">cmt.base_tasks.base</span> <span class="kn">import</span> <span class="n">ConfigTaskWithCategory</span><span class="p">,</span> <span class="n">HTCondorWorkflow</span><span class="p">,</span> <span class="n">SGEWorkflow</span>
<span class="kn">from</span> <span class="nn">cmt.base_tasks.plotting</span> <span class="kn">import</span> <span class="n">FeaturePlot</span>

<span class="n">ROOT</span> <span class="o">=</span> <span class="n">import_root</span><span class="p">()</span>

<span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;down&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="FitBase"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.FitBase">[docs]</a><span class="k">class</span> <span class="nc">FitBase</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">convert_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">blind_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">):</span>
        <span class="c1"># fit range</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># blinded range</span>
        <span class="n">blind</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blind_range</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">blind_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">blind_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">blind</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">blind_range</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">blind_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">blind_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">blind_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                <span class="n">blind_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">x</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="s2">&quot;loSB&quot;</span><span class="p">,</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">blind_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="s2">&quot;hiSB&quot;</span><span class="p">,</span> <span class="n">blind_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">x</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fit_range</span> <span class="o">=</span> <span class="s2">&quot;loSB,hiSB&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">blind</span>

    <span class="k">def</span> <span class="nf">get_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fit_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">fit_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fit_name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;voigtian&quot;</span><span class="p">:</span>
            <span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
            <span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
            <span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span>
            <span class="n">fit_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_parameters</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">)</span>

            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Mean of Voigtian&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">])</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;Gamma of Voigtian&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">])</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma of Voigtian&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">])</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooVoigtian</span><span class="p">(</span><span class="n">fit_name</span><span class="p">,</span> <span class="n">fit_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">fit_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">fit_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_parameters</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooPolynomial</span><span class="p">(</span><span class="n">fit_name</span><span class="p">,</span> <span class="n">fit_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
            <span class="c1"># https://root.cern.ch/doc/master/classRooExponential.html</span>
            <span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">fit_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_parameters</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">])</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooExponential</span><span class="p">(</span><span class="n">fit_name</span><span class="p">,</span> <span class="n">fit_name</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;powerlaw&quot;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">fit_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">fit_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">fit_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_parameters</span><span class="p">(</span><span class="n">fit_parameters</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
                <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">fit_parameters</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>

            <span class="n">fit_fun</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> * TMath::Power(@0, @</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooGenericPdf</span><span class="p">(</span><span class="n">fit_name</span><span class="p">,</span> <span class="n">fit_fun</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="k">return</span> <span class="n">fun</span><span class="p">,</span> <span class="n">params</span></div>


<div class="viewcode-block" id="CombineBase"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineBase">[docs]</a><span class="k">class</span> <span class="nc">CombineBase</span><span class="p">(</span><span class="n">FeaturePlot</span><span class="p">,</span> <span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base task for all combine-related tasks</span>

<span class="sd">    :param pois: Parameters-of-interest to be considered</span>
<span class="sd">    :type pois: list of `str`</span>

<span class="sd">    :param higgs_mass: Higgs mass to be considered inside combine</span>
<span class="sd">    :type higgs_mass: int</span>

<span class="sd">    :param fit_models: filename with fit models to use in the fit</span>
<span class="sd">    :type fit_models: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pois</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;parameters of interest to be considered, &quot;</span>
        <span class="s2">&quot;default: r&quot;</span><span class="p">)</span>
    <span class="n">higgs_mass</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">IntParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">125</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Higgs mass to be used inside &quot;</span>
        <span class="s2">&quot;combine, default: 125&quot;</span><span class="p">)</span>
    <span class="n">fit_models</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;filename with fit models to use &quot;</span>
        <span class="s2">&quot;in the fit, default: none (binned fit)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CombineBase.get_output_postfix"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineBase.get_output_postfix">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_postfix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;process_group_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span><span class="p">)</span>
        <span class="n">process_group_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span> <span class="k">else</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span><span class="p">)</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="k">else</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">process_group_name</span> <span class="o">+</span> <span class="n">region_name</span></div></div>


<div class="viewcode-block" id="CombineCategoriesTask"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineCategoriesTask">[docs]</a><span class="k">class</span> <span class="nc">CombineCategoriesTask</span><span class="p">(</span><span class="n">CombineBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base task for all combine-related tasks with multiple categories</span>

<span class="sd">    :param category_names: names of categories to run</span>
<span class="sd">    :type category_names: list of `str`</span>

<span class="sd">    :param combine_categories: whether to run on the combined datacard or per category</span>
<span class="sd">    :type combine_categories: bool</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">category_names</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;names of categories &quot;</span>
        <span class="s2">&quot;to run, default: (base,)&quot;</span><span class="p">)</span>
    <span class="n">combine_categories</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to run on the &quot;</span>
        <span class="s2">&quot;combined datacard or per category, default: False (per category)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="CombineCategoriesTask.get_output_postfix"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineCategoriesTask.get_output_postfix">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_postfix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">postfix</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CombineCategoriesTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_names</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">postfix</span></div>

    <span class="k">def</span> <span class="nf">store_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CombineCategoriesTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">store_parts</span><span class="p">()</span>
        <span class="c1"># parts[&quot;category_name&quot;] = &quot;cat_combined&quot;</span>
        <span class="k">del</span> <span class="n">parts</span><span class="p">[</span><span class="s2">&quot;category_name&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">parts</span></div>


<div class="viewcode-block" id="CreateDatacards"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateDatacards">[docs]</a><span class="k">class</span> <span class="nc">CreateDatacards</span><span class="p">(</span><span class="n">CombineBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that creates datacards for its use inside the combine framework</span>

<span class="sd">    :param automcstats: Value used for autoMCStats inside the datacard, -1 to avoid using it.</span>
<span class="sd">    :type automcstats: int</span>

<span class="sd">    :param additional_lines: Additional lines to write at the end of the datacard.</span>
<span class="sd">    :type additional_lines: list of `str`</span>

<span class="sd">    :param propagate_syst_qcd: Whether to propagate systematics to estimated qcd background.</span>
<span class="sd">    :type propagate_syst_qcd: bool</span>

<span class="sd">    :param counting: whether the datacard should consider a counting experiment</span>
<span class="sd">    :type counting: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">automcstats</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">IntParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;value used for autoMCStats inside &quot;</span>
        <span class="s2">&quot;the datacard, -1 to avoid using it, default: 10&quot;</span><span class="p">)</span>
    <span class="n">additional_lines</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;addtional lines to write at the &quot;</span>
        <span class="s2">&quot;end of the datacard&quot;</span><span class="p">)</span>
    <span class="n">propagate_syst_qcd</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to propagate&quot;</span>
        <span class="s2">&quot;systematics to estimated qcd background, default: False&quot;</span><span class="p">)</span>
    <span class="n">counting</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether the datacard should consider &quot;</span>
        <span class="s2">&quot;a counting experiment, default: False&quot;</span><span class="p">)</span>

    <span class="n">additional_scaling</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">DictParameter</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;dict with scalings to be &quot;</span>
        <span class="s2">&quot;applied to processes in the datacard, ONLY IMPLEMENTED FOR PARAMETRIC FITS, default: None&quot;</span><span class="p">)</span>
    <span class="n">additional_scaling</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Temporary fix, the DictParameter fails when empty</span>

    <span class="n">norm_syst_threshold</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">norm_syst_threshold_sym</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CreateDatacards</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isData</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only 1 data process can be provided inside the process group&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isData</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_qcd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;qcd&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_models</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">yaml</span>
            <span class="kn">from</span> <span class="nn">cmt.utils.yaml_utils</span> <span class="kn">import</span> <span class="n">ordered_load</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieve_file</span><span class="p">(</span><span class="s2">&quot;config/</span><span class="si">{}</span><span class="s2">.yaml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_models</span><span class="p">)))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">ordered_load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">SafeLoader</span><span class="p">)</span>

<div class="viewcode-block" id="CreateDatacards.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateDatacards.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Needs as input the root file provided by the FeaturePlot task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">counting</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FeaturePlot</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hide_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize_signals</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># FIXME allow counting datacards starting from FeaturePlot</span>
            <span class="n">reqs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fits&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;inspections&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">fit_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">])</span>
                <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">param</span> <span class="o">!=</span> <span class="s2">&quot;fit_parameters&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="s2">&quot;fit_parameters&quot;</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">+=</span> <span class="s2">&quot;, fit_parameters={&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;fit_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
                <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Fit.vreq(self, </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">, _exclude=[&#39;include_fit&#39;])&quot;</span><span class="p">)</span>
                <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;inspections&quot;</span><span class="p">][</span><span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;InspectFitSyst.vreq(self, </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">, _exclude=[&#39;include_fit&#39;])&quot;</span><span class="p">)</span>

            <span class="c1"># In order to have a workspace with data_obs, we replicate the first fit</span>
            <span class="c1"># (just in case the x_range is defined) for the available data process</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">)</span>
            <span class="n">fit_params</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">param</span> <span class="o">!=</span> <span class="s2">&quot;fit_parameters&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;fit_parameters&quot;</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">+=</span> <span class="s2">&quot;, fit_parameters={&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;fit_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
            <span class="n">reqs</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="s2">&quot;data_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit.vreq(self, </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">, _exclude=[&#39;include_fit&#39;])&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">reqs</span></div>

<div class="viewcode-block" id="CreateDatacards.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateDatacards.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns, per feature, one txt storing the datacard and its corresponding root file</span>
<span class="sd">        storing the histograms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;txt&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">counting</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">(),</span>
                    <span class="n">key</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">reqs</span></div>

    <span class="k">def</span> <span class="nf">get_norm_systematics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_systematics</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_norm_systematics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_norm_systematics_from_inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
        <span class="c1"># structure: systematics[syst_name][process_name] = syst_value</span>
        <span class="n">systematics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;inspections&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">up_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;up&quot;</span><span class="p">]</span>
                <span class="n">down_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;down&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">up_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">or</span> <span class="n">down_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">up_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_syst_threshold</span> <span class="ow">or</span> \
                        <span class="nb">abs</span><span class="p">(</span><span class="n">down_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_syst_threshold</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">syst_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">systematics</span><span class="p">:</span>
                        <span class="n">systematics</span><span class="p">[</span><span class="n">syst_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># symmetric?</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">up_value</span> <span class="o">+</span> <span class="n">down_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_syst_threshold_sym</span><span class="p">:</span>
                        <span class="n">systematics</span><span class="p">[</span><span class="n">syst_name</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">up_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">systematics</span><span class="p">[</span><span class="n">syst_name</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">/</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">up_value</span><span class="p">,</span>
                            <span class="mi">1</span> <span class="o">+</span> <span class="n">down_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">systematics</span>

    <span class="k">def</span> <span class="nf">get_shape_systematics_from_inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">round_unc</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">exp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">exp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># structure: systematics[syst_name][process_name][parameter] = syst_value</span>
        <span class="n">systematics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;inspections&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="n">feature_name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;integral&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">up_value</span> <span class="o">=</span> <span class="n">round_unc</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;up&quot;</span><span class="p">]))</span>
                    <span class="n">down_value</span> <span class="o">=</span> <span class="n">round_unc</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;down&quot;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">up_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">or</span> <span class="n">down_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">up_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_syst_threshold</span> <span class="ow">or</span> \
                            <span class="nb">abs</span><span class="p">(</span><span class="n">down_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_syst_threshold</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">systematics</span><span class="p">:</span>
                            <span class="n">systematics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">systematics</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                            <span class="n">systematics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">systematics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">syst_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">up_value</span><span class="p">,</span> <span class="n">down_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">systematics</span>

    <span class="k">def</span> <span class="nf">write_datacard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yields</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">norm_systematics</span><span class="p">,</span> <span class="n">shape_systematics</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">n_dashes</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="k">else</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">bin_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">bin_name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">))])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">)</span>

        <span class="n">sig_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bkg_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span><span class="o">.</span><span class="n">isSignal</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_counter</span><span class="p">)</span>
                    <span class="n">sig_counter</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">)</span>
                    <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># qcd coming from do_qcd</span>
                <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">)</span>
                <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">yields</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">])</span>

        <span class="c1"># normalization systematics</span>
        <span class="k">for</span> <span class="n">norm_syst</span> <span class="ow">in</span> <span class="n">norm_systematics</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm_syst</span><span class="p">,</span> <span class="s2">&quot;lnN&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">norm_systematics</span><span class="p">[</span><span class="n">norm_syst</span><span class="p">]:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_systematics</span><span class="p">[</span><span class="n">norm_syst</span><span class="p">][</span><span class="n">p_name</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># shape systematics</span>
        <span class="k">for</span> <span class="n">shape_syst</span> <span class="ow">in</span> <span class="n">shape_systematics</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape_syst</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">shape_systematics</span><span class="p">[</span><span class="n">shape_syst</span><span class="p">]:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">fancy_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;txt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">max  *</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">letter</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;shapes  *  </span><span class="si">{0}</span><span class="s2">  </span><span class="si">{1}</span><span class="s2">  $PROCESS  $PROCESS_$SYSTEMATIC</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2">  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">bin_name</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;observation  -1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">automcstats</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;*  autoMCStats  </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">automcstats</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_shape_datacard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">norm_systematics</span><span class="p">,</span> <span class="n">shape_systematics</span><span class="p">,</span>
            <span class="n">datacard_syst_params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">n_dashes</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="k">else</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">bin_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)</span>

        <span class="n">shapes_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
            <span class="n">shapes_table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;shapes&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bin_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s2">&quot;workspace_</span><span class="si">{0}</span><span class="s2">:model_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span><span class="p">:</span>
                <span class="c1"># We are extracting the background from the data, so let&#39;s label it as background</span>
                <span class="c1"># but let&#39;s be sure background is not in the process_group_name</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="s2">&quot;background&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">shapes_table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;shapes&quot;</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="n">bin_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="s2">&quot;workspace_</span><span class="si">{0}</span><span class="s2">:model_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)])</span>

        <span class="c1"># Include shape for the data</span>
        <span class="n">shapes_table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;shapes&quot;</span><span class="p">,</span> <span class="s2">&quot;data_obs&quot;</span><span class="p">,</span> <span class="n">bin_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s2">&quot;workspace_data_obs:data_obs&quot;</span><span class="p">])</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">process_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span><span class="p">:</span>
                <span class="n">process_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">)</span>

        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">bin_name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">process_names</span><span class="p">))])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">process_names</span><span class="p">)</span>

        <span class="n">sig_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bkg_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">process_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span><span class="o">.</span><span class="n">isSignal</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_counter</span><span class="p">)</span>
                    <span class="n">sig_counter</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">)</span>
                    <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># qcd coming from do_qcd or background coming from data</span>
                <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">)</span>
                <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">rate_line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">process_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s2">&quot;background&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span><span class="p">:</span>
                <span class="c1"># assuming it comes from data, may cause problems in certain setups</span>
                <span class="n">rate_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="s2">&quot;integral&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">rate</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">))</span>
                <span class="n">rate_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate_line</span><span class="p">)</span>

        <span class="c1"># normalization systematics</span>
        <span class="k">for</span> <span class="n">norm_syst</span> <span class="ow">in</span> <span class="n">norm_systematics</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm_syst</span><span class="p">,</span> <span class="s2">&quot;lnN&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">norm_systematics</span><span class="p">[</span><span class="n">norm_syst</span><span class="p">]:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_systematics</span><span class="p">[</span><span class="n">norm_syst</span><span class="p">][</span><span class="n">p_name</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># shape systematics</span>
        <span class="k">for</span> <span class="n">syst_param</span> <span class="ow">in</span> <span class="n">datacard_syst_params</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">syst_param</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

        <span class="n">fancy_shapes_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">shapes_table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fancy_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;txt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">max  *</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">letter</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fancy_shapes_table</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2">  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">bin_name</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;observation  -1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># if self.automcstats != -1:</span>
                <span class="c1"># f.write(&quot;*  autoMCStats  %s \n&quot; % self.automcstats)</span>

            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_rate_for_counting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s2">&quot;background&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span><span class="p">:</span>
            <span class="c1"># assuming it comes from data, may cause problems in certain setups</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="s2">&quot;integral&quot;</span><span class="p">]</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="s2">&quot;integral_error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="s2">&quot;integral_error&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="s2">&quot;integral_error&quot;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">rate</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">))</span>
                <span class="n">weight</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_scaling</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">rate</span><span class="p">,</span> <span class="n">weight</span>

    <span class="k">def</span> <span class="nf">get_stat_unc_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">process_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">round_unc</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">exp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">exp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">process_names</span><span class="p">:</span>
            <span class="n">process_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">process_names</span><span class="p">:</span>
            <span class="c1"># line = [f&quot;{p_name}_norm&quot;, &quot;gmN {:.2f}&quot;.format(rates[p_name][0] * rates[p_name][1])]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">category_name</span><span class="si">}</span><span class="s2">_norm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;gmN </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">1</span><span class="p">])))]</span>
            <span class="n">append_line</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">p_name</span> <span class="ow">or</span> \
                        <span class="n">p_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_children_from_process</span><span class="p">(</span><span class="n">name</span><span class="p">)]:</span>
                    <span class="k">if</span> <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                        <span class="n">append_line</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># line.append(&quot;{:.4f}&quot;.format(1. / rates[p_name][1]))</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">round_unc</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">append_line</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span>

    <span class="k">def</span> <span class="nf">write_counting_datacard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">norm_systematics</span><span class="p">,</span> <span class="n">shape_systematics</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">n_dashes</span> <span class="o">=</span> <span class="mi">50</span>

        <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="k">else</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">bin_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">process_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_processes</span><span class="p">:</span>
                <span class="n">process_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">)</span>

        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">bin_name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">process_names</span><span class="p">))])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">process_names</span><span class="p">)</span>

        <span class="n">sig_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bkg_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">process_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span><span class="o">.</span><span class="n">isSignal</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_counter</span><span class="p">)</span>
                    <span class="n">sig_counter</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">)</span>
                    <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># qcd coming from do_qcd or background coming from data</span>
                <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bkg_counter</span><span class="p">)</span>
                <span class="n">bkg_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">rate_line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">process_names</span><span class="p">:</span>
            <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_process_rate_for_counting</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span><span class="o">.</span><span class="n">isSignal</span> <span class="ow">and</span> <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rate_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate_line</span><span class="p">)</span>

        <span class="c1"># normalization systematics</span>
        <span class="k">for</span> <span class="n">norm_syst</span> <span class="ow">in</span> <span class="n">norm_systematics</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm_syst</span><span class="p">,</span> <span class="s2">&quot;lnN&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">norm_systematics</span><span class="p">[</span><span class="n">norm_syst</span><span class="p">]:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_systematics</span><span class="p">[</span><span class="n">norm_syst</span><span class="p">][</span><span class="n">p_name</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># statistical uncertainty</span>
        <span class="n">stat_unc_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stat_unc_lines</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">rates</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">+=</span> <span class="n">stat_unc_lines</span>

        <span class="c1"># # # shape systematics</span>
        <span class="c1"># # for shape_syst in shape_systematics:</span>
            <span class="c1"># # line = [shape_syst, &quot;shape&quot;]</span>
            <span class="c1"># # for p_name in self.non_data_names:</span>
                <span class="c1"># # if p_name in shape_systematics[shape_syst]:</span>
                    <span class="c1"># # line.append(1)</span>
                <span class="c1"># # else:</span>
                    <span class="c1"># # line.append(&quot;-&quot;)</span>
            <span class="c1"># # table.append(line)</span>

        <span class="n">fancy_table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;txt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">max  *</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">letter</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;11}</span><span class="s2">  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">bin_name</span><span class="p">))</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="s2">&quot;data_obs&quot;</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_data</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f_data</span><span class="p">)</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="s2">&quot;integral&quot;</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;observation  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rate</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">n_dashes</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fancy_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="CreateDatacards.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateDatacards.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Splits the processes into data and non-data. Per feature, loads the input histograms, </span>
<span class="sd">        creates the output histograms and the datacard inside the txt file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="n">norm_systematics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm_systematics</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">systs_directions</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
            <span class="n">shape_syst_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systs</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">systs_directions</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">shape_syst_list</span><span class="p">,</span> <span class="n">directions</span><span class="p">))</span>

            <span class="c1"># Convert the shape systematics list to a dict with the systs as keys and a list of </span>
            <span class="c1"># the processes affected by them (all non-data processes except the qcd if computed</span>
            <span class="c1"># in the code)</span>
            <span class="n">shape_systematics</span> <span class="o">=</span> <span class="p">{</span><span class="n">shape_syst</span><span class="p">:</span> <span class="p">[</span><span class="n">p_name</span> <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">shape_syst</span> <span class="ow">in</span> <span class="n">shape_syst_list</span><span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">counting</span><span class="p">:</span>  <span class="c1"># binned fits</span>
                <span class="n">histos</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">:</span>
                    <span class="n">histos</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;histograms/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="n">systs_directions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">syst</span> <span class="o">==</span> <span class="s2">&quot;central&quot;</span><span class="p">:</span>
                            <span class="n">name_to_save</span> <span class="o">=</span> <span class="n">name</span>
                            <span class="n">name_from_featureplot</span> <span class="o">=</span> <span class="n">name</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_qcd</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;qcd&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">name_to_save</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
                            <span class="n">name_from_featureplot</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">syst</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                        <span class="n">histos</span><span class="p">[</span><span class="n">name_to_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;histograms/&quot;</span> <span class="o">+</span> <span class="n">name_from_featureplot</span><span class="p">))</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

                <span class="n">yields</span> <span class="o">=</span> <span class="p">{</span><span class="n">name_central</span><span class="p">:</span> <span class="n">histos</span><span class="p">[</span><span class="n">name_central</span><span class="p">]</span><span class="o">.</span><span class="n">Integral</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">name_central</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_data_names</span><span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_datacard</span><span class="p">(</span><span class="n">yields</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span>
                    <span class="n">norm_systematics</span><span class="p">,</span> <span class="n">shape_systematics</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_lines</span><span class="p">)</span>

                <span class="n">tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="s2">&quot;RECREATE&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">histo</span> <span class="ow">in</span> <span class="n">histos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;data_obs&quot;</span>
                    <span class="n">histo</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">counting</span><span class="p">:</span>  <span class="c1"># unbinned fits</span>
                <span class="n">shape_systematics_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shape_systematics_from_inspect</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># shape_systematics_feature = {}</span>
                <span class="n">datacard_syst_params</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="s2">&quot;RECREATE&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">fit_params</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">model_tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span>
                        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">model_tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;workspace_&quot;</span> <span class="o">+</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape_systematics_feature</span><span class="p">:</span>
                        <span class="c1"># directly extract the workspace from the inputs</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
                        <span class="n">model_tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># create a new workspace with the dedicated systematics</span>
                        <span class="n">x_range</span> <span class="o">=</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x_range&quot;</span><span class="p">,</span> <span class="n">Fit</span><span class="o">.</span><span class="n">x_range</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                            <span class="n">x_range</span> <span class="o">=</span> <span class="n">x_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
                        <span class="n">blind_range</span> <span class="o">=</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blind_range&quot;</span><span class="p">,</span> <span class="n">Fit</span><span class="o">.</span><span class="n">blind_range</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
                        <span class="n">method</span> <span class="o">=</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">)</span>

                        <span class="n">x</span><span class="p">,</span> <span class="n">blind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">blind_range</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="s2">&quot;data_obs&quot;</span><span class="p">)</span>
                        <span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">fit_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fit_parameters&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fit</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">fit_parameters</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                        <span class="c1"># for param in params:</span>
                            <span class="c1"># param.setConstant(True)</span>

                        <span class="c1"># let&#39;s build the RooFormulaVar for each param (w/ or w/o systematics)</span>
                        <span class="n">param_syst</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                        <span class="n">systs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape_systematics_feature</span><span class="p">[</span><span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]]:</span>
                                <span class="c1"># no systematics to add, only need to consider the actual parameter</span>
                                <span class="n">param_syst</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">systs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">syst_values</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">syst</span><span class="p">,</span> <span class="n">syst_value</span> <span class="ow">in</span> \
                                        <span class="n">shape_systematics_feature</span><span class="p">[</span><span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">]][</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="n">systs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                                    <span class="n">systs</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">syst_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syst_value</span><span class="p">)</span>
                                    <span class="n">datacard_syst_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">param_syst</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFormulaVar</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_syst&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_syst&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;@0*&quot;</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;(1+</span><span class="si">{</span><span class="n">syst_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">*@</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span>
                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">syst_values</span><span class="p">))]),</span>
                                    <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">systs</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>

                        <span class="c1"># Create the new fitting function</span>
                        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;voigtian&quot;</span><span class="p">:</span>
                            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooVoigtian</span><span class="p">(</span><span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span>
                                <span class="n">param_syst</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">param_syst</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">],</span> <span class="n">param_syst</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">:</span>
                            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooPolynomial</span><span class="p">(</span><span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span>
                                <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">param_syst</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
                        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
                            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooExponential</span><span class="p">(</span><span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">param_syst</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;powerlaw&quot;</span><span class="p">:</span>
                            <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                            <span class="n">fit_fun</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> * TMath::Power(@0, @</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">)&quot;</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
                            <span class="n">fun</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooGenericPdf</span><span class="p">(</span><span class="s2">&quot;model_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">,</span>
                                <span class="n">fit_fun</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

                        <span class="c1"># Refit</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">blind</span><span class="p">:</span>
                            <span class="n">fun</span><span class="o">.</span><span class="n">fitTo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFit</span><span class="o">.</span><span class="n">SumW2Error</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fun</span><span class="o">.</span><span class="n">fitTo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFit</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                                <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFit</span><span class="o">.</span><span class="n">SumW2Error</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

                        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="n">value</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                        <span class="c1"># save the function inside the workspace</span>
                        <span class="n">w_name</span> <span class="o">=</span> <span class="s2">&quot;workspace_syst&quot;</span>
                        <span class="n">workspace_syst</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooWorkspace</span><span class="p">(</span><span class="n">w_name</span><span class="p">,</span> <span class="n">w_name</span><span class="p">)</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">workspace_syst</span><span class="p">,</span> <span class="s2">&quot;import&quot;</span><span class="p">)(</span><span class="n">fun</span><span class="p">)</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">workspace_syst</span><span class="p">,</span> <span class="s2">&quot;import&quot;</span><span class="p">)(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
                        <span class="n">workspace_syst</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&quot;workspace_&quot;</span> <span class="o">+</span> <span class="n">fit_params</span><span class="p">[</span><span class="s2">&quot;process_name&quot;</span><span class="p">])</span>
                        <span class="n">model_tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

                <span class="c1"># data_obs</span>
                <span class="n">model_tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">][</span><span class="s2">&quot;data_obs&quot;</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">model_tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;workspace_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
                <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="s2">&quot;workspace_data_obs&quot;</span><span class="p">)</span>
                <span class="n">model_tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

                <span class="n">norm_systematics_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm_systematics_from_inspect</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">norm_systematics_feature</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">norm_systematics</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_shape_datacard</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">norm_systematics_feature</span><span class="p">,</span> <span class="n">shape_systematics</span><span class="p">,</span>
                    <span class="n">datacard_syst_params</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_lines</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># counting experiment</span>
                <span class="n">norm_systematics_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm_systematics_from_inspect</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">norm_systematics_feature</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">norm_systematics</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_counting_datacard</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">norm_systematics_feature</span><span class="p">,</span> <span class="n">shape_systematics</span><span class="p">,</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_lines</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Fit"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.Fit">[docs]</a><span class="k">class</span> <span class="nc">Fit</span><span class="p">(</span><span class="n">FeaturePlot</span><span class="p">,</span> <span class="n">FitBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that run fits over FeaturePlot histograms</span>

<span class="sd">    :param method: Fitting method to consider. To choose between `voigtian`, `polynomial`,</span>
<span class="sd">        `exponential`, `powerlaw`.</span>
<span class="sd">    :type method: str</span>

<span class="sd">    :param process_name: Process name to consider.</span>
<span class="sd">    :type process_name: str</span>

<span class="sd">    :param x_range: Range of the x axis to consider in the fitting.</span>
<span class="sd">    :type x_range: Two comma-separated `float`.</span>

<span class="sd">    :param blind_range: Range of the x axis to blind in the fitting.</span>
<span class="sd">    :type blind_range: Two comma-separated `float`.</span>

<span class="sd">    :param fit_parameters: Initial values for the parameters involved in the fit.</span>
<span class="sd">    :type fit_parameters: `str` representing a dict (e.g. &#39;{\&quot;mean\&quot;: \&quot;(20, -100, 100)\&quot;}&#39;).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">ChoiceParameter</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;voigtian&quot;</span><span class="p">,</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">,</span> <span class="s2">&quot;exponential&quot;</span><span class="p">,</span> <span class="s2">&quot;powerlaw&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;voigtian&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;fitting method to consider, default: voigtian&quot;</span><span class="p">)</span>
    <span class="n">process_name</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;process name to consider, &quot;</span>
        <span class="s2">&quot;default: signal&quot;</span><span class="p">)</span>
    <span class="n">x_range</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;1.2&quot;</span><span class="p">,</span> <span class="s2">&quot;1.5&quot;</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;range of the x axis to consider &quot;</span>
        <span class="s2">&quot;in the fit, default: 1.2-1.5&quot;</span><span class="p">)</span>
    <span class="n">blind_range</span> <span class="o">=</span> <span class="n">law</span><span class="o">.</span><span class="n">CSVParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;range of the x axis to blind &quot;</span>
        <span class="s2">&quot;in the fit, default: none&quot;</span><span class="p">)</span>
    <span class="n">fit_parameters</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">DictParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">{},</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Initial values for the parameters &quot;</span>
        <span class="s2">&quot;involved in the fit, defaults depend on the method. Should be included as &quot;</span>
        <span class="s2">&quot;--fit-parameters &#39;{</span><span class="se">\&quot;</span><span class="s2">mean</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">(20, -100, 100)</span><span class="se">\&quot;</span><span class="s2">}&#39;&quot;</span><span class="p">)</span>

    <span class="n">normalize_signals</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Fit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Fit.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.Fit.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Needs as input the root file provided by the FeaturePlot task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">FeaturePlot</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hide_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">normalize_signals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_yields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fit.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.Fit.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns, per feature, one json file storing the fit results and one root file</span>
<span class="sd">        storing the workspace</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x0</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">blind</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.</span>
            <span class="k">else</span> <span class="s2">&quot;__blinded&quot;</span><span class="p">)</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="k">else</span> <span class="s2">&quot;__</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">blind</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">key</span>
                <span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Fit.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.Fit.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains the fits per feature and systematic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">process_group_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">process_group_name</span><span class="p">]</span>

        <span class="n">isMC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">)</span><span class="o">.</span><span class="n">isMC</span>
        <span class="k">for</span> <span class="n">ifeat</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
            <span class="n">systs_directions</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;central&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">isMC</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_systematics</span><span class="p">:</span>
                <span class="n">systs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_systs</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">isMC</span><span class="p">)</span>
                <span class="n">systs_directions</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">systs</span><span class="p">,</span> <span class="n">directions</span><span class="p">))</span>

            <span class="c1"># fit range</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">blind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span><span class="p">)</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">blind</span><span class="p">:</span>
                <span class="n">x_blind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span><span class="p">)</span>
                <span class="n">l_blind</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgList</span><span class="p">(</span><span class="n">x_blind</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">syst_name</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">systs_directions</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">syst_name</span> <span class="o">!=</span> <span class="s2">&quot;central&quot;</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">syst_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">histo</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;histograms/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span> <span class="o">+</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The histogram has not been created for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooDataHist</span><span class="p">(</span><span class="s2">&quot;data_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;data_obs&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">histo</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">blind</span><span class="p">:</span>
                    <span class="n">data_blind</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooDataHist</span><span class="p">(</span><span class="s2">&quot;data_obs_blind&quot;</span><span class="p">,</span> <span class="s2">&quot;data_obs_blind&quot;</span><span class="p">,</span> <span class="n">l_blind</span><span class="p">,</span> <span class="n">histo</span><span class="p">)</span>

                <span class="n">frame</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">frame</span><span class="p">()</span>
                <span class="n">data</span><span class="o">.</span><span class="n">plotOn</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

                <span class="n">n_non_zero_bins</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">histo</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">histo</span><span class="o">.</span><span class="n">GetBinContent</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n_non_zero_bins</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># get function to fit and its parameters</span>
                <span class="n">fun</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_parameters</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
                    <span class="n">fit_name</span><span class="o">=</span><span class="s2">&quot;model_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">)</span>

                <span class="c1"># fitting</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">blind</span><span class="p">:</span>
                    <span class="n">fun</span><span class="o">.</span><span class="n">fitTo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFit</span><span class="o">.</span><span class="n">SumW2Error</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fun</span><span class="o">.</span><span class="n">fitTo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFit</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                        <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                        <span class="n">ROOT</span><span class="o">.</span><span class="n">RooFit</span><span class="o">.</span><span class="n">SumW2Error</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

                <span class="n">npar</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">getParameters</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">selectByAttrib</span><span class="p">(</span><span class="s2">&quot;Constant&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span>

                <span class="c1"># filling output dict with fitting results</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">getVal</span><span class="p">()</span>
                    <span class="c1"># setting the parameter as constant before saving it in the workspace</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">setConstant</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># needs further studying</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;voigtian&quot;</span><span class="p">:</span>
                    <span class="n">gamma_value</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getVal</span><span class="p">()</span>
                    <span class="n">sigma_value</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">getVal</span><span class="p">()</span>
                    <span class="n">G</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gamma_value</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;HWHM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5346</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.2166</span> <span class="o">*</span> <span class="n">L</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">G</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

                <span class="n">histo_new</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">createHistogram</span><span class="p">(</span><span class="s2">&quot;histo_new&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                <span class="n">integral</span> <span class="o">=</span> <span class="n">histo_new</span><span class="o">.</span><span class="n">IntegralAndError</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">histo_new</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">blind</span><span class="p">:</span>
                    <span class="n">histo_blind</span> <span class="o">=</span> <span class="n">data_blind</span><span class="o">.</span><span class="n">createHistogram</span><span class="p">(</span><span class="s2">&quot;histo_blind&quot;</span><span class="p">,</span> <span class="n">x_blind</span><span class="p">)</span>
                    <span class="n">error_blind</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                    <span class="n">integral_blind</span> <span class="o">=</span> <span class="n">histo_blind</span><span class="o">.</span><span class="n">IntegralAndError</span><span class="p">(</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="n">histo_blind</span><span class="o">.</span><span class="n">GetNbinsX</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error_blind</span><span class="p">)</span>

                <span class="c1"># Additional results to include in the output dict</span>
                <span class="n">fun</span><span class="o">.</span><span class="n">plotOn</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;chi2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">chiSquare</span><span class="p">()</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;npar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">npar</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;chi2/ndf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">chiSquare</span><span class="p">(</span><span class="n">npar</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;Number of non-zero bins&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_non_zero_bins</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;Full chi2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">chiSquare</span><span class="p">()</span> <span class="o">*</span> <span class="n">n_non_zero_bins</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ndf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_non_zero_bins</span> <span class="o">-</span> <span class="n">npar</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;integral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sumEntries</span><span class="p">()</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;fit_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_range</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;blind_range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">blind</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">blind_range</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;sum_entries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sumEntries</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">blind</span> <span class="k">else</span> <span class="n">data_blind</span><span class="o">.</span><span class="n">sumEntries</span><span class="p">())</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;integral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">-</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">blind</span> <span class="k">else</span> <span class="n">integral_blind</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;integral_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">blind</span> <span class="k">else</span> <span class="n">error_blind</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

                <span class="n">w_name</span> <span class="o">=</span> <span class="s2">&quot;workspace_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span> <span class="o">+</span> <span class="n">key</span>
                <span class="n">workspace</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooWorkspace</span><span class="p">(</span><span class="n">w_name</span><span class="p">,</span> <span class="n">w_name</span><span class="p">)</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="s2">&quot;import&quot;</span><span class="p">)(</span><span class="n">fun</span><span class="p">)</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="s2">&quot;import&quot;</span><span class="p">)(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">workspace</span><span class="o">.</span><span class="n">Print</span><span class="p">()</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span>
                    <span class="s2">&quot;UPDATE&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">cd</span><span class="p">()</span>
                <span class="n">workspace</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InspectFitSyst"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.InspectFitSyst">[docs]</a><span class="k">class</span> <span class="nc">InspectFitSyst</span><span class="p">(</span><span class="n">Fit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that extracts systematic effects on the fits.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="InspectFitSyst.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.InspectFitSyst.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Needs as input the json file provided by the Fit task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Fit</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="InspectFitSyst.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.InspectFitSyst.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns, per feature, one json file and one txt file storing the inspection results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="k">else</span> <span class="s2">&quot;__</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">region_name</span><span class="p">)),</span>
                <span class="s2">&quot;txt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}</span><span class="s2">__</span><span class="si">{}{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">region_name</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="InspectFitSyst.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.InspectFitSyst.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">isMC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_name</span><span class="p">)</span><span class="o">.</span><span class="n">isMC</span>
        <span class="k">for</span> <span class="n">ifeat</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
            <span class="n">systs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_systs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_systs</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">isMC</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_weights_systematics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">isMC</span><span class="p">))</span>

            <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;voigtian&quot;</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;powerlaw&quot;</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;a</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;b</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">)]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">syst</span> <span class="ow">in</span> <span class="n">systs</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">syst</span><span class="p">]</span>
                <span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;up&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;down&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;up&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_up&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">])</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;down&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_down&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">])</span> <span class="o">/</span>\
                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;up&quot;</span><span class="p">])</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">syst</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;down&quot;</span><span class="p">])</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">tabulate</span><span class="o">.</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;syst name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">directions</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;txt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CombineDatacards"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineDatacards">[docs]</a><span class="k">class</span> <span class="nc">CombineDatacards</span><span class="p">(</span><span class="n">CombineCategoriesTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that combines datacards coming from :class:`.CreateDatacards`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">category_name</span> <span class="o">=</span> <span class="s2">&quot;base&quot;</span>
    <span class="n">combine_categories</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CombineDatacards.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineDatacards.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Needs as input the datacards provided by the CreateDatacards task for each category</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">category_name</span><span class="p">:</span> <span class="n">CreateDatacards</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_name</span><span class="o">=</span><span class="n">category_name</span><span class="p">,</span>
                <span class="n">_exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;category_names&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">category_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="CombineDatacards.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineDatacards.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs a txt file with the merged datacard</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="CombineDatacards.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CombineDatacards.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines all datacards using combine&#39;s combineCards.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;combineCards.py &quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">force_shape</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">category_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">category_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">inputs</span><span class="p">[</span><span class="n">category_name</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;txt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="n">category_name</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;txt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;shapes&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">force_shape</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">force_shape</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;--force-shape &quot;</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">create_file_dir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CreateWorkspace"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateWorkspace">[docs]</a><span class="k">class</span> <span class="nc">CreateWorkspace</span><span class="p">(</span><span class="n">CreateDatacards</span><span class="p">,</span> <span class="n">CombineCategoriesTask</span><span class="p">,</span>
        <span class="n">law</span><span class="o">.</span><span class="n">LocalWorkflow</span><span class="p">,</span> <span class="n">HTCondorWorkflow</span><span class="p">,</span> <span class="n">SGEWorkflow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that creates the Combine workspace from the datacards obtained from</span>
<span class="sd">    :class:`.CreateDatacards` or :class:`.CombineDatacards`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">category_name</span> <span class="o">=</span> <span class="s2">&quot;base&quot;</span>

<div class="viewcode-block" id="CreateWorkspace.create_branch_map"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateWorkspace.create_branch_map">[docs]</a>    <span class="k">def</span> <span class="nf">create_branch_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns one branch if categories are combined or one branch per category</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_names</span><span class="p">)</span></div>

<div class="viewcode-block" id="CreateWorkspace.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateWorkspace.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the datacard coming from CombineDatacards or one datacard per category obtained by</span>
<span class="sd">        CreateDatacards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CombineDatacards</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">category_name</span><span class="p">:</span> <span class="n">CreateDatacards</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_name</span><span class="o">=</span><span class="n">category_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">category_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="CreateWorkspace.workflow_requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateWorkspace.workflow_requires">[docs]</a>    <span class="k">def</span> <span class="nf">workflow_requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the datacard coming from CombineDatacards or one datacard per category obtained by</span>
<span class="sd">        CreateDatacards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">CombineDatacards</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">category_name</span><span class="p">:</span> <span class="n">CreateDatacards</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category_name</span><span class="o">=</span><span class="n">category_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">category_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span>
            <span class="p">}</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="CreateWorkspace.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateWorkspace.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs one root file with the workspace if categories are combined or one per category.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;workspace_</span><span class="si">{}{}</span><span class="s2">.root&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">()</span> <span class="p">))</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="CreateWorkspace.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.CreateWorkspace.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtains the workspace for each provided datacard.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_names</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch</span><span class="p">]][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;txt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;text2workspace.py </span><span class="si">{}</span><span class="s2"> -m </span><span class="si">{}</span><span class="s2"> -o </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">inp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">higgs_mass</span><span class="p">,</span> <span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RunCombine"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.RunCombine">[docs]</a><span class="k">class</span> <span class="nc">RunCombine</span><span class="p">(</span><span class="n">CreateWorkspace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that runs the combine tool over the workspace created by</span>
<span class="sd">    :class:`.CreateWorkspace`.</span>

<span class="sd">    :param method: Combine method to consider. Only `limits` (AsymptoticLimits) is implemented for</span>
<span class="sd">        now.</span>
<span class="sd">    :type method: str</span>

<span class="sd">    :param unblind: Whether to run combine unblinded.</span>
<span class="sd">    :type method: bool</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">method</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">ChoiceParameter</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,),</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;combine method to be considered, default: False&quot;</span><span class="p">)</span>
    <span class="n">unblind</span> <span class="o">=</span> <span class="n">luigi</span><span class="o">.</span><span class="n">BoolParameter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;whether to run combine unblinded, &quot;</span>
        <span class="s2">&quot;default: False&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RunCombine.workflow_requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.RunCombine.workflow_requires">[docs]</a>    <span class="k">def</span> <span class="nf">workflow_requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the workspace coming from CreateWorkspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">CreateWorkspace</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)}</span></div>

<div class="viewcode-block" id="RunCombine.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.RunCombine.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the workspace coming from CreateWorkspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CreateWorkspace</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunCombine.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.RunCombine.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs one txt file and one root file in total or one of each per category with the results</span>
<span class="sd">        of running combine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">category_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;results_</span><span class="si">{}{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">(),</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="RunCombine.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.RunCombine.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs combine over the provided workspaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;limits&quot;</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="s2">&quot;higgsCombine</span><span class="si">{}</span><span class="s2">.AsymptoticLimits.mH</span><span class="si">{}</span><span class="s2">.root&quot;</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">test_name</span> <span class="o">=</span> <span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;combine -M &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;limits&quot;</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;AsymptoticLimits &quot;</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;--name </span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unblind</span><span class="p">:</span>  <span class="c1"># not sure if this is only for AsymptoticLimits</span>
                <span class="n">cmd</span> <span class="o">+=</span> <span class="s2">&quot;--run blind &quot;</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-m </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">higgs_mass</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; &gt; </span><span class="si">{</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;txt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">move</span><span class="p">(</span><span class="n">out_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">higgs_mass</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PullsAndImpacts"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PullsAndImpacts">[docs]</a><span class="k">class</span> <span class="nc">PullsAndImpacts</span><span class="p">(</span><span class="n">RunCombine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that obtains the pulls and impacts over the workspace created by :class:`.CreateWorkspace`.</span>
<span class="sd">    Based on https://gitlab.cern.ch/hh/tools/inference/-/blob/master/dhi/tasks/pulls_impacts.py</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_selected_nuisances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nuisances</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nuisances</span>

    <span class="k">def</span> <span class="nf">extract_nuisance_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">prepare_prefit_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Prepares a RooRealVar *var* for the extraction of its prefit values using the corresponding</span>
<span class="sd">            *pdf* object. Internally, this is done using a made-up fit with precision *epsilon* following a</span>
<span class="sd">            recipe in the CombineHarvester (see</span>
<span class="sd">            https://github.com/cms-analysis/CombineHarvester/blob/f1029e160701140ce3a1c1f44a991315fd272886/CombineTools/python/combine/utils.py#L87-L95).  # noqa</span>
<span class="sd">            *var* is returned.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">var</span> <span class="ow">and</span> <span class="n">pdf</span><span class="p">:</span>
                <span class="n">nll</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooConstraintSum</span><span class="p">(</span><span class="s2">&quot;NLL&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgSet</span><span class="p">(</span><span class="n">pdf</span><span class="p">),</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgSet</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
                <span class="n">minimizer</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooMinimizer</span><span class="p">(</span><span class="n">nll</span><span class="p">)</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">setEps</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">setErrorLevel</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">setPrintLevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">setVerbose</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="s2">&quot;Minuit2&quot;</span><span class="p">,</span> <span class="s2">&quot;migrad&quot;</span><span class="p">)</span>
                <span class="n">minimizer</span><span class="o">.</span><span class="n">minos</span><span class="p">(</span><span class="n">ROOT</span><span class="o">.</span><span class="n">RooArgSet</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">var</span>

        <span class="n">tf</span> <span class="o">=</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">TFile</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">genobj</span><span class="p">(</span><span class="s2">&quot;ModelConfig&quot;</span><span class="p">)</span>
        <span class="n">all_params</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">GetPdf</span><span class="p">()</span><span class="o">.</span><span class="n">getParameters</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">GetObservables</span><span class="p">())</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">all_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooRealVar</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">isConstant</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">pdf</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span><span class="si">}</span><span class="s2">_Pdf&quot;</span><span class="p">)</span>
            <span class="n">gobs</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span><span class="si">}</span><span class="s2">_In&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pdf</span> <span class="ow">and</span> <span class="n">gobs</span><span class="p">:</span>
                <span class="n">prepare_prefit_var</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">pdf</span><span class="p">)</span>
                <span class="n">nom</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">getVal</span><span class="p">()</span>
                <span class="n">prefit</span> <span class="o">=</span> <span class="p">[</span><span class="n">nom</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">getErrorLo</span><span class="p">(),</span> <span class="n">nom</span><span class="p">,</span> <span class="n">nom</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">getErrorHi</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooGaussian</span><span class="p">):</span>
                    <span class="n">pdf_type</span> <span class="o">=</span> <span class="s2">&quot;Gaussian&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooPoisson</span><span class="p">):</span>
                    <span class="n">pdf_type</span> <span class="o">=</span> <span class="s2">&quot;Poisson&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooBifurGauss</span><span class="p">):</span>
                    <span class="n">pdf_type</span> <span class="o">=</span> <span class="s2">&quot;AsymmetricGaussian&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pdf_type</span> <span class="o">=</span> <span class="s2">&quot;Unrecognised&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">pdf</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">ROOT</span><span class="o">.</span><span class="n">RooUniform</span><span class="p">):</span>
                <span class="n">pdf_type</span> <span class="o">=</span> <span class="s2">&quot;Unconstrained&quot;</span>
                <span class="n">nom</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">getVal</span><span class="p">()</span>
                <span class="n">prefit</span> <span class="o">=</span> <span class="p">[</span><span class="n">nom</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">nom</span><span class="p">]</span>

            <span class="c1"># get groups</span>
            <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;group_&quot;</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">attributes</span><span class="p">()</span> <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">start</span><span class="p">)]</span>

            <span class="c1"># store it</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">GetName</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">GetName</span><span class="p">(),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">pdf_type</span><span class="p">,</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="p">,</span>
                <span class="s2">&quot;prefit&quot;</span><span class="p">:</span> <span class="n">prefit</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">tf</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="nd">@law</span><span class="o">.</span><span class="n">workflow_property</span><span class="p">(</span><span class="n">setter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">empty_value</span><span class="o">=</span><span class="n">law</span><span class="o">.</span><span class="n">no_value</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">workspace_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ws_input</span> <span class="o">=</span> <span class="n">CreateWorkspace</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ws_input</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">law</span><span class="o">.</span><span class="n">no_value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_nuisance_names</span><span class="p">(</span><span class="n">ws_input</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PullsAndImpacts</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="PullsAndImpacts.create_branch_map"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PullsAndImpacts.create_branch_map">[docs]</a>    <span class="k">def</span> <span class="nf">create_branch_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nuisance parameters considered in the fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nuisance_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_selected_nuisances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nuisance_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_branch_map</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuisance_names</span></div>

<div class="viewcode-block" id="PullsAndImpacts.workflow_requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PullsAndImpacts.workflow_requires">[docs]</a>    <span class="k">def</span> <span class="nf">workflow_requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the workspace coming from CreateWorkspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">CreateWorkspace</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">,</span> <span class="s2">&quot;branch&quot;</span><span class="p">])}</span></div>

<div class="viewcode-block" id="PullsAndImpacts.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PullsAndImpacts.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the workspace coming from CreateWorkspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CreateWorkspace</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_exclude</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;branches&quot;</span><span class="p">,</span> <span class="s2">&quot;branch&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="PullsAndImpacts.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PullsAndImpacts.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs one log, root file, and json per nuisance paramter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;results_</span><span class="si">{}{}</span><span class="s2">__</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="PullsAndImpacts.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PullsAndImpacts.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the combine commands needed for pulls and impacts computations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;collection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">w_path</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;combine -M MultiDimFit -n _initialFit --algo singles &quot;</span>
                    <span class="s2">&quot;--redefineSignalPOIs </span><span class="si">{poi}</span><span class="s2"> </span><span class="si">{toys}</span><span class="s2"> -m </span><span class="si">{mass}</span><span class="s2"> -d </span><span class="si">{workspace}</span><span class="s2"> &gt; </span><span class="si">{log_file}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="s2">&quot;higgsCombine_initialFit.MultiDimFit.mH</span><span class="si">{mass}</span><span class="s2">.root&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;combine -M MultiDimFit -n _paramFit_Test_</span><span class="si">{param}</span><span class="s2"> --algo impact &quot;</span>
                    <span class="s2">&quot;--redefineSignalPOIs </span><span class="si">{poi}</span><span class="s2"> -P </span><span class="si">{param}</span><span class="s2"> --floatOtherPOIs 1 --saveInactivePOI 1 &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{toys}</span><span class="s2"> -m </span><span class="si">{mass}</span><span class="s2"> -d </span><span class="si">{workspace}</span><span class="s2"> &gt; </span><span class="si">{log_file}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="s2">&quot;higgsCombine_paramFit_Test_</span><span class="si">{param}</span><span class="s2">.MultiDimFit.mH</span><span class="si">{mass}</span><span class="s2">.root&quot;</span>

            <span class="n">toys</span> <span class="o">=</span> <span class="s2">&quot;--toys -1&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unblind</span><span class="p">:</span>
                <span class="n">toys</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">log_file</span> <span class="o">=</span> <span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">poi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">toys</span><span class="o">=</span><span class="n">toys</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">higgs_mass</span><span class="p">,</span>
                <span class="n">workspace</span><span class="o">=</span><span class="n">w_path</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running &quot;</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="n">move</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;log&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="n">move</span><span class="p">(</span><span class="n">out_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">higgs_mass</span><span class="p">),</span>
                <span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

            <span class="n">tree</span> <span class="o">=</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">:</span> <span class="n">tree</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">array</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;prefit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">][</span><span class="s2">&quot;prefit&quot;</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">][</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branch_data</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MergePullsAndImpacts"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.MergePullsAndImpacts">[docs]</a><span class="k">class</span> <span class="nc">MergePullsAndImpacts</span><span class="p">(</span><span class="n">CombineCategoriesTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that merges the pulls and impacts for each systematic obtained by :class:`.PullsAndImpacts`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">category_name</span> <span class="o">=</span> <span class="s2">&quot;base&quot;</span>

<div class="viewcode-block" id="MergePullsAndImpacts.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.MergePullsAndImpacts.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the json files coming from PullsAndImpacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PullsAndImpacts</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="MergePullsAndImpacts.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.MergePullsAndImpacts.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs one json file (in CombineHarvester format) with the results for all</span>
<span class="sd">        nuisance parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;results_</span><span class="si">{}{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="MergePullsAndImpacts.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.MergePullsAndImpacts.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges the results from the PullsAndImpacts task into one json file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()[</span><span class="s2">&quot;collection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span>
        <span class="n">nuisance_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">()</span><span class="o">.</span><span class="n">get_branch_map</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># includes POI</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;POIs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;POIs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">nuisance_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;fit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]]</span>
            <span class="p">})</span>

            <span class="k">for</span> <span class="n">inuis</span><span class="p">,</span> <span class="n">nuisance_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nuisance_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">nuisance_name</span><span class="p">})</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="n">inuis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;json&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">nuisance_name</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">nuisance_name</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">nuisance_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;impact_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">abs</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">pois</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])))</span>
                <span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;prefit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;prefit&quot;</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">create_file_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PlotPullsAndImpacts"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PlotPullsAndImpacts">[docs]</a><span class="k">class</span> <span class="nc">PlotPullsAndImpacts</span><span class="p">(</span><span class="n">MergePullsAndImpacts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that plots pulls and impacts coming from :class:`.MergePullsAndImpacts`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PlotPullsAndImpacts.requires"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PlotPullsAndImpacts.requires">[docs]</a>    <span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires the json file with all pulls and impacts obtained by MergePullsAndImpacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MergePullsAndImpacts</span><span class="o">.</span><span class="n">vreq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="PlotPullsAndImpacts.output"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PlotPullsAndImpacts.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs one pdf with the pulls and impacts obtained by CombineHarvester.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combine_categories</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">category_names</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_target</span><span class="p">(</span><span class="s2">&quot;impacts_</span><span class="si">{}{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_postfix</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="PlotPullsAndImpacts.run"><a class="viewcode-back" href="../../../api/base_tasks/analysis.html#cmt.base_tasks.analysis.PlotPullsAndImpacts.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the pulls and impacts using CombineHarvester&#39;s plotImpacts.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">randomize</span><span class="p">(</span><span class="s2">&quot;impacts&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;plotImpacts.py -i </span><span class="si">{}</span><span class="s2"> -o </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">inp</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">out</span>
            <span class="p">))</span>
            <span class="n">move</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>